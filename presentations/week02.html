<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.9.1: http://docutils.sourceforge.net/" />
<meta name="version" content="S5 1.1" />
<title>Internet Programming with Python</title>
<link rel="stylesheet" href="ui/uw_pce_theme/pretty.css" type="text/css" />
<!-- configuration parameters -->
<meta name="defaultView" content="slideshow" />
<meta name="controlVis" content="hidden" />
<!-- style sheet links -->
<script src="ui/uw_pce_theme/slides.js" type="text/javascript"></script>
<link rel="stylesheet" href="ui/uw_pce_theme/slides.css"
      type="text/css" media="projection" id="slideProj" />
<link rel="stylesheet" href="ui/uw_pce_theme/outline.css"
      type="text/css" media="screen" id="outlineStyle" />
<link rel="stylesheet" href="ui/uw_pce_theme/print.css"
      type="text/css" media="print" id="slidePrint" />
<link rel="stylesheet" href="ui/uw_pce_theme/opera.css"
      type="text/css" media="projection" id="operaFix" />
</head>
<body>
<div class="layout">
<div id="controls"></div>
<div id="currentSlide"></div>
<div id="header">

</div>
<div id="footer">
<h1>Internet Programming with Python</h1>
<h2><a class="reference external" href="http://github.com/cewing/training.python_web">View document source</a>.
</h2>
</div>
</div>
<div class="presentation">
<div class="slide" id="slide0">
<h1 class="title">Internet Programming with Python</h1>

<img alt="img/protocol.png" class="align-left" src="img/protocol.png" style="width: 45%;" />
<p>Week 2: Web Protocols</p>
<p class="intro-blurb">Wherein we learn about the languages that the internet speaks and how to
choose the right one for our message</p>

</div>
<div class="slide" id="but-first">
<h1>But First</h1>
<p class="big-centered">Review from the Assignment</p>
</div>
<div class="slide" id="clean-up-after-yourself">
<h1>Clean Up After Yourself</h1>
<p>very few of you closed your server socket before exiting the server script:</p>
<pre class="small literal-block">
server = socket.socket()
# set up
try:
    while True
        # do server stuff
except KeyboardInterrupt:
    server.close()
    sys.exit()
</pre>
</div>
<div class="slide" id="use-module-constants">
<h1>Use Module Constants</h1>
<p>Constants are provided to help us 'do the right thing' without needing to
remember what the right thing is, exactly.  So, instead of:</p>
<pre class="literal-block">
socket.socket(2,1,0)
</pre>
<p>use:</p>
<pre class="literal-block">
socket.socket(socket.AF_INET,
              socket.SOCK_STREAM,
              socket.IPPROTO_IP)
</pre>
</div>
<div class="slide" id="interaction-can-be-good">
<h1>Interaction Can Be Good</h1>
<pre class="tiny literal-block">
try:
    # generate two numbers
    while True:
        try:
            number_one = int(raw_input(&quot;Enter the first number in the sum: &quot;))
            break
        except ValueError:
            print &quot;Oops!  That was no valid number.  Try again...&quot;

    while True:
        try:
            number_two = int(raw_input(&quot;Enter the second number in the sum: &quot;))
            break
        except ValueError:
            print &quot;Oops!  That was no valid number.  Try again...&quot;
</pre>
</div>
<div class="slide" id="a-tricksy-bug">
<h1>A Tricksy Bug</h1>
<pre class="small literal-block">
...
while 1:
    conn, addr = server_socket.accept()
    print &quot;Connection Established.&quot;
    # Keep connection alive.
    while 1:
        data = conn.recv(4096)
        listIn = literal_eval(data)
        print 'Values: %s, Type: %s' % (listIn, type(listIn))
        conn.sendall('Sum: %s\n' % sum(listIn))

conn.close()
server_socket.close()
</pre>
</div>
<div class="slide" id="the-result">
<h1>The Result</h1>
<p>Client: prints correct value</p>
<p>Server: prints <tt class="docutils literal">Values: [0, 1, 2, 3], Type: &lt;type 'list'&gt;</tt></p>
<p>Server:</p>
<pre class="tiny incremental literal-block">
Traceback (most recent call last):
  File &quot;training.python_web/assignments/week01/athome/number_server.py&quot;, line 34, in &lt;module&gt;
    listIn = literal_eval(data)
  File &quot;/System/Library/Frameworks/Python.framework/Versions/2.6/lib/python2.6/ast.py&quot;, line 49, in literal_eval
    node_or_string = parse(node_or_string, mode='eval')
  File &quot;/System/Library/Frameworks/Python.framework/Versions/2.6/lib/python2.6/ast.py&quot;, line 37, in parse
    return compile(expr, filename, mode, PyCF_ONLY_AST)
  File &quot;&lt;unknown&gt;&quot;, line 0

    ^
SyntaxError: unexpected EOF while parsing
</pre>
</div>
<div class="slide" id="screen">
<h1>Screen</h1>
<p>For running scripts on a *nix server and keeping them running, even after you
disconnect:</p>
<pre class="literal-block">
$ screen
$ start_process
&lt;ctrl-a ctrl-d&gt;
Screen Detached
$ screen -ls # lists your screens
$ screen -r connects to only running screen
</pre>
</div>
<div class="slide" id="and-second">
<h1>And Second</h1>
<p class="big-centered">Questions from the Reading?</p>
</div>
<div class="slide" id="and-third">
<h1>And Third</h1>
<p class="big-centered">Dan Explains Git!!!</p>
</div>
<div class="slide" id="and-now">
<h1>And Now...</h1>
<img alt="img/protocol_sea.png" class="align-center" src="img/protocol_sea.png" style="width: 48%;" />
<p class="image-credit">image exerpted from: <a class="reference external" href="http://xkcd.com/802/">http://xkcd.com/802/</a></p>
</div>
<div class="slide" id="what-is-a-protocol">
<h1>What is a Protocol?</h1>
<p class="incremental center">a set of rules or conventions</p>
<p class="incremental center">governing communications</p>
</div>
<div class="slide" id="protocols-irl">
<h1>Protocols IRL</h1>
<p>Life has lots of sets of rules for how to do things.</p>
<ul class="incremental simple">
<li>What do you do on a first date?</li>
<li>What do you do in a job interview?</li>
<li>What do (and don't) you talk about at a dinner party?</li>
<li>...?</li>
</ul>
</div>
<div class="slide" id="id1">
<h1>Protocols IRL</h1>
<img alt="img/icup.png" class="align-center" src="img/icup.png" style="width: 58%;" />
<p class="image-credit"><a class="reference external" href="http://blog.xkcd.com/2009/09/02/urinal-protocol-vulnerability/">http://blog.xkcd.com/2009/09/02/urinal-protocol-vulnerability/</a></p>
</div>
<div class="slide" id="protocols-in-computers">
<h1>Protocols In Computers</h1>
<p>Digital life has lots of rules too:</p>
<ul class="incremental simple">
<li>how to identify yourself</li>
<li>how to find a conversation partner</li>
<li>how to ask for information</li>
<li>how to provide answers</li>
<li>how to say goodbye</li>
</ul>
</div>
<div class="slide" id="real-protocol-examples">
<h1>Real Protocol Examples</h1>
<p class="big-centered">What does this look like in practice?</p>
</div>
<div class="slide" id="id2">
<h1>Real Protocol Examples</h1>
<ul class="incremental simple">
<li>SMTP (Simple Message Transfer Protocol)
<a class="reference external" href="http://tools.ietf.org/html/rfc5321#appendix-D">http://tools.ietf.org/html/rfc5321#appendix-D</a></li>
<li>POP3 (Post Office Protocol)
<a class="reference external" href="http://www.faqs.org/docs/artu/ch05s03.html">http://www.faqs.org/docs/artu/ch05s03.html</a></li>
<li>IMAP (Internet Message Access Protocol)
<a class="reference external" href="http://www.faqs.org/docs/artu/ch05s03.html">http://www.faqs.org/docs/artu/ch05s03.html</a></li>
<li>HTTP (Hyper-Text Transfer Protocol)
<a class="reference external" href="http://en.wikipedia.org/wiki/Hypertext_Transfer_Protocol">http://en.wikipedia.org/wiki/Hypertext_Transfer_Protocol</a></li>
</ul>
</div>
<div class="slide" id="what-does-smtp-look-like">
<h1>What does SMTP look like?</h1>
<p>SMTP (Identify yourself and find a partner):</p>
<pre class="literal-block">
S: 220 foo.com Simple Mail Transfer Service Ready
C: EHLO bar.com
S: 250-foo.com greets bar.com
S: 250-8BITMIME
S: 250-SIZE
S: 250-DSN
S: 250 HELP
</pre>
</div>
<div class="slide" id="id3">
<h1>What does SMTP look like?</h1>
<p>SMTP (Ask for information, provide answers):</p>
<pre class="literal-block">
C: MAIL FROM:&lt;Smith&#64;bar.com&gt;
S: 250 OK
C: RCPT TO:&lt;Jones&#64;foo.com&gt;
S: 250 OK
C: RCPT TO:&lt;Green&#64;foo.com&gt;
S: 550 No such user here
C: DATA
S: 354 Start mail input; end with &lt;CRLF&gt;.&lt;CRLF&gt;
C: Blah blah blah...
C: ...etc. etc. etc.
C: .
S: 250 OK
</pre>
</div>
<div class="slide" id="id4">
<h1>What does SMTP look like?</h1>
<p>SMTP (Say goodbye):</p>
<pre class="literal-block">
C: QUIT
S: 221 foo.com Service closing transmission channel
</pre>
</div>
<div class="slide" id="what-does-pop3-look-like">
<h1>What does POP3 look like?</h1>
<p>POP3 (Identify yourself and find a partner):</p>
<pre class="literal-block">
C: &lt;client connects to service port 110&gt;
S: +OK POP3 server ready &lt;1896.6971&#64;mailgate.dobbs.org&gt;
C: USER bob
S: +OK bob
C: PASS redqueen
S: +OK bob's maildrop has 2 messages (320 octets)
</pre>
</div>
<div class="slide" id="id5">
<h1>What does POP3 look like?</h1>
<p>POP3 (Ask for information, provide answers):</p>
<pre class="literal-block">
C: STAT
S: +OK 2 320
C: LIST
S: +OK 2 messages (320 octets)
S: 1 120
S: 2 200
S: .
</pre>
</div>
<div class="slide" id="id6">
<h1>What does POP3 look like?</h1>
<p>POP3 (Ask for information, provide answers):</p>
<pre class="literal-block">
C: RETR 1
S: +OK 120 octets
S: &lt;the POP3 server sends the text of message 1&gt;
S: .
C: DELE 1
S: +OK message 1 deleted
C: RETR 2
S: +OK 200 octets
S: &lt;the POP3 server sends the text of message 2&gt;
S: .
C: DELE 2
S: +OK message 2 deleted
</pre>
</div>
<div class="slide" id="id7">
<h1>What does POP3 look like?</h1>
<p>POP3 (Say goodbye):</p>
<pre class="literal-block">
C: QUIT
S: +OK dewey POP3 server signing off (maildrop empty)
C: &lt;client hangs up&gt;
</pre>
</div>
<div class="slide" id="what-does-imap-look-like">
<h1>What does IMAP look like?</h1>
<p>IMAP (Identify yourself and find a partner):</p>
<pre class="literal-block">
C: &lt;client connects to service port 143&gt;
S: * OK example.com IMAP4rev1 v12.264 server ready
C: A0001 USER &quot;frobozz&quot; &quot;xyzzy&quot;
S: * OK User frobozz authenticated
</pre>
</div>
<div class="slide" id="id8">
<h1>What does IMAP look like?</h1>
<p>IMAP (Ask for information, provide answers [connect to an inbox]):</p>
<pre class="literal-block">
C: A0002 SELECT INBOX
S: * 1 EXISTS
S: * 1 RECENT
S: * FLAGS (\Answered \Flagged \Deleted \Draft \Seen)
S: * OK [UNSEEN 1] first unseen message in /var/spool/mail/esr
S: A0002 OK [READ-WRITE] SELECT completed
</pre>
</div>
<div class="slide" id="id9">
<h1>What does IMAP look like?</h1>
<p>IMAP (Ask for information, provide answers [Get message sizes]):</p>
<pre class="literal-block">
C: A0003 FETCH 1 RFC822.SIZE
S: * 1 FETCH (RFC822.SIZE 2545)
S: A0003 OK FETCH completed
</pre>
</div>
<div class="slide" id="id10">
<h1>What does IMAP look like?</h1>
<p>IMAP (Ask for information, provide answers [Get first message header]):</p>
<pre class="literal-block">
C: A0004 FETCH 1 BODY[HEADER]
S: * 1 FETCH (RFC822.HEADER {1425}
&lt;server sends 1425 octets of message payload&gt;
S: )
S: A0004 OK FETCH completed
</pre>
</div>
<div class="slide" id="id11">
<h1>What does IMAP look like?</h1>
<p>IMAP (Ask for information, provide answers [Get first message body]):</p>
<pre class="literal-block">
C: A0005 FETCH 1 BODY[TEXT]
S: * 1 FETCH (BODY[TEXT] {1120}
&lt;server sends 1120 octets of message payload&gt;
S: )
S: * 1 FETCH (FLAGS (\Recent \Seen))
S: A0005 OK FETCH completed
</pre>
</div>
<div class="slide" id="id12">
<h1>What does IMAP look like?</h1>
<p>IMAP (Say goodbye):</p>
<pre class="literal-block">
C: A0006 LOGOUT
S: * BYE example.com IMAP4rev1 server terminating connection
S: A0006 OK LOGOUT completed
C: &lt;client hangs up&gt;
</pre>
</div>
<div class="slide" id="notice-any-difference">
<h1>Notice Any Difference?</h1>
<p>POP3 Commands:</p>
<ul class="incremental simple">
<li>STAT</li>
<li>LIST</li>
<li>RETR 1</li>
<li>DELE 1</li>
<li>QUIT</li>
</ul>
</div>
<div class="slide" id="id13">
<h1>Notice Any Difference?</h1>
<p>IMAP Commands:</p>
<ul class="incremental simple">
<li>A0001 USER &quot;frobozz&quot; &quot;xyzzy&quot;</li>
<li>A0002 SELECT INBOX</li>
<li>A0003 FETCH 1 RFC822.SIZE</li>
<li>A0004 FETCH 1 BODY[HEADER]</li>
<li>A0005 FETCH 1 BODY[TEXT]</li>
<li>A0006 LOGOUT</li>
</ul>
</div>
<div class="slide" id="id14">
<h1>Notice Any Difference?</h1>
<p>Sequence Identifiers allow the client to send commands without waiting for
responses.</p>
</div>
<div class="slide" id="re-ordered-imap-interaction">
<h1>Re-ordered IMAP Interaction</h1>
<pre class="literal-block">
C: A0001 USER &quot;frobozz&quot; &quot;xyzzy&quot;
S: * OK User frobozz authenticated
C: A0002 SELECT INBOX
S: ...
S: A0002 OK [READ-WRITE] SELECT completed
C: A0003 FETCH 1 RFC822.SIZE
C: A0004 FETCH 1 BODY[HEADER]
C: A0005 FETCH 1 BODY[TEXT]
S: * 1 FETCH (RFC822.SIZE 2545)
S: A0003 OK FETCH completed
...
...
C: A0006 LOGOUT
...
</pre>
</div>
<div class="slide" id="which-protocol-do-you-choose">
<h1>Which Protocol do you Choose?</h1>
<p>Stacking commands is more efficient, but would it work for POP3?</p>
<p class="incremental">Why not?</p>
</div>
<div class="slide" id="what-does-http-look-like">
<h1>What does HTTP look like?</h1>
<p>HTTP (Ask for information):</p>
<pre class="literal-block">
GET /index.html HTTP/1.1
Host: www.example.com
\r\n
</pre>
</div>
<div class="slide" id="id15">
<h1>What does HTTP look like?</h1>
<p>HTTP (Provide answers):</p>
<pre class="literal-block">
HTTP/1.1 200 OK
Date: Mon, 23 May 2005 22:38:34 GMT
Server: Apache/1.3.3.7 (Unix) (Red-Hat/Linux)
Last-Modified: Wed, 08 Jan 2003 23:11:55 GMT
Etag: &quot;3f80f-1b6-3e1cb03b&quot;
Accept-Ranges:  none
Content-Length: 438
Connection: close
Content-Type: text/html; charset=UTF-8
\r\n
&lt;438 bytes of content&gt;
</pre>
</div>
<div class="slide" id="protocols-in-python">
<h1>Protocols in Python</h1>
<p class="big-centered">Let's try this out for ourselves!</p>
</div>
<div class="slide" id="id16">
<h1>Protocols in Python</h1>
<p class="big-centered">Fire up a Python interpreter</p>
</div>
<div class="slide" id="smtp-in-python">
<h1>SMTP in Python</h1>
<p>Start by importing smtplib (part of the standard library):</p>
<pre class="literal-block">
&gt;&gt;&gt; import smtplib
&gt;&gt;&gt; dir(smtplib)
['CRLF', 'LMTP', 'LMTP_PORT', 'OLDSTYLE_AUTH',
 'SMTP', 'SMTPAuthenticationError', 'SMTPConnectError',
 'SMTPDataError', 'SMTPException', 'SMTPHeloError',
 'SMTPRecipientsRefused', 'SMTPResponseException',
 'SMTPSenderRefused', 'SMTPServerDisconnected',
 'SMTP_PORT', 'SMTP_SSL', 'SMTP_SSL_PORT', 'SSLFakeFile',
 '__all__', '__builtins__', '__doc__', '__file__',
 '__name__', '__package__', '_have_ssl', 'base64', 'email',
 'encode_base64', 'hmac', 'quoteaddr', 'quotedata', 're',
 'socket', 'ssl', 'stderr']
</pre>
</div>
<div class="slide" id="id17">
<h1>SMTP in Python</h1>
<p>Let's make a connection to a server. We'll use one I've set up in advance to
avoid needing to create one of our own:</p>
<pre class="literal-block">
&gt;&gt;&gt; server = smtplib.SMTP('smtp.webfaction.com', 587)
&gt;&gt;&gt; server.set_debuglevel(True) # to see interaction
&gt;&gt;&gt; server.ehlo()
send: 'ehlo heffalump.local\r\n'
reply: '250-smtp.webfaction.com\r\n'
reply: '250-PIPELINING\r\n'
reply: '250-SIZE 20971520\r\n'
reply: '250-VRFY\r\n'
reply: '250-ETRN\r\n'
reply: '250-STARTTLS\r\n'
...
</pre>
</div>
<div class="slide" id="id18">
<h1>SMTP in Python</h1>
<p>Does our server support TLS (secure transmissions?):</p>
<pre class="literal-block">
&gt;&gt;&gt; server.has_extn('STARTTLS')
True
</pre>
<p>What other extensions are available?:</p>
<pre class="literal-block">
&gt;&gt;&gt; server.esmpt_features.keys()
['enhancedstatuscodes', 'etrn', 'starttls',
 'auth', 'dsn', '8bitmime', 'pipelining',
 'size', 'vrfy']
</pre>
</div>
<div class="slide" id="id19">
<h1>SMTP in Python</h1>
<p>Some SMTP servers require authentication. This is one such server. Before
passing our username and password, though, we should turn on TLS for the sake
of security:</p>
<pre class="literal-block">
&gt;&gt;&gt; server.starttls()
&gt;&gt;&gt; server.ehlo() # re-identify after TLS begins
&gt;&gt;&gt; server.login(username, password)
</pre>
</div>
<div class="slide" id="id20">
<h1>SMTP in Python</h1>
<p>Let's prepare a message to be sent to our server:</p>
<pre class="literal-block">
&gt;&gt;&gt; from_addr = &quot;YOUR NAME &lt;fill in this address&gt;&quot;
&gt;&gt;&gt; to_addrs = &quot;demo&#64;crisewing.com&quot;
&gt;&gt;&gt; subject = &quot;this is a test&quot;
&gt;&gt;&gt; message = &quot;a message from python smtplib&quot;
</pre>
</div>
<div class="slide" id="id21">
<h1>SMTP in Python</h1>
<p>Email sent via SMTP requires certain formatting. It's part of the Protocol. In
particular, note that the headers are separated by CRLF sequences.  This is
very common across internet protocols:</p>
<pre class="literal-block">
&gt;&gt;&gt; template = &quot;From: %s\r\nTo: %s\r\nSubject: %s\r\n\r\n&quot;
&gt;&gt;&gt; headers = template % (from_addr, to_addrs, subject)
</pre>
</div>
<div class="slide" id="id22">
<h1>SMTP in Python</h1>
<p>A message is the headers, plus the body of the message:</p>
<pre class="literal-block">
&gt;&gt;&gt; email_body = headers + message
</pre>
<p>Sending the email is accomplished by calling the <tt class="docutils literal">sendmail</tt> method on our
server object, after which we should close the connection:</p>
<pre class="literal-block">
&gt;&gt;&gt; server.sendmail(from_addr, [to_addrs, ], email_body)
&gt;&gt;&gt; server.close()
</pre>
</div>
<div class="slide" id="putting-it-all-together">
<h1>Putting it all Together</h1>
<pre class="literal-block">
&gt;&gt;&gt; from_addr = &quot;YOUR NAME &lt;fill in this address&gt;&quot;
&gt;&gt;&gt; to_addrs = &quot;demo&#64;crisewing.com&quot;
&gt;&gt;&gt; subject = &quot;this is a test&quot;
&gt;&gt;&gt; message = &quot;a message from python smtplib&quot;
&gt;&gt;&gt; template = &quot;From: %s\r\nTo: %s\r\nSubject: %s\r\n\r\n&quot;
&gt;&gt;&gt; headers = template % (from_addr, to_addrs, subject)
</pre>
</div>
<div class="slide" id="id23">
<h1>Putting it all Together</h1>
<pre class="literal-block">
&gt;&gt;&gt; server = smtplib.SMTP('smtp.webfaction.com', 587)
&gt;&gt;&gt; server.set_debuglevel(True)
&gt;&gt;&gt; server.ehlo()
&gt;&gt;&gt; server.starttls()
&gt;&gt;&gt; server.ehlo() # re-identify after TLS begins
&gt;&gt;&gt; server.login(username, password)
&gt;&gt;&gt; email_body = headers + message
&gt;&gt;&gt; server.sendmail(from_addr, [to_addrs, ], email_body)
&gt;&gt;&gt; server.close()
</pre>
</div>
<div class="slide" id="python-means-batteries-included">
<h1>Python Means Batteries Included</h1>
<p>So in fact we have a module in the standard library for email support:</p>
<pre class="literal-block">
&gt;&gt;&gt; import email.utils
&gt;&gt;&gt; from email.mime.text import MIMEText
&gt;&gt;&gt; from_addr = &quot;addr&#64;host.com&quot;
&gt;&gt;&gt; to_addrs = &quot;other&#64;another.com&quot;
&gt;&gt;&gt; msg = MIMEText(&quot;This is an email message&quot;)
&gt;&gt;&gt; msg['From'] = email.utils.formataddr((&quot;Name&quot;, from_addr))
&gt;&gt;&gt; msg['To'] = email.utils.formataddr((&quot;Name&quot;, to_addrs))
&gt;&gt;&gt; msg['Subject'] = &quot;Simple Test&quot;
&gt;&gt;&gt; server.sendmail(from_addr, [to_addrs, ], msg.as_string())
</pre>
</div>
<div class="slide" id="imap-in-python">
<h1>IMAP in Python</h1>
<p class="big-centered">Let's read that email we just sent</p>
</div>
<div class="slide" id="id24">
<h1>IMAP in Python</h1>
<p>Again, begin by importing the module from the Python Standard Library:</p>
<pre class="literal-block">
&gt;&gt;&gt; import imaplib
&gt;&gt;&gt; dir(imaplib)
['AllowedVersions', 'CRLF', 'Commands',
 'Continuation', 'Debug', 'Flags', 'IMAP4',
 'IMAP4_PORT', 'IMAP4_SSL', 'IMAP4_SSL_PORT',
 'IMAP4_stream', 'Int2AP', 'InternalDate',
 'Internaldate2tuple', 'Literal', 'MapCRLF',
 'Mon2num', 'ParseFlags', 'Response_code',
 'Time2Internaldate', 'Untagged_response',
 'Untagged_status', '_Authenticator', ...]
</pre>
</div>
<div class="slide" id="id25">
<h1>IMAP in Python</h1>
<p>We set up a client object.  WebFaction requires SSL for connecting to IMAP
servers, so let's initialize an IMAP4_SSL client and authenticate:</p>
<pre class="literal-block">
&gt;&gt;&gt; conn = imaplib.IMAP4_SSL('mail.webfaction.com')
  57:04.83 imaplib version 2.58
  57:04.83 new IMAP4 connection, tag=FNHG
&gt;&gt;&gt; conn.login(username, password)
('OK', ['Logged in.'])
</pre>
</div>
<div class="slide" id="id26">
<h1>IMAP in Python</h1>
<p>Let's set up debugging here too, so that we can see the communication back and
forth between client and server:</p>
<pre class="literal-block">
&gt;&gt;&gt; conn.debug = 4 # &gt;3 prints all messages
</pre>
<p>We can start by listing the mailboxes we have on the server:</p>
<pre class="literal-block">
&gt;&gt;&gt; conn.list()
  00:41.91 &gt; FNHG3 LIST &quot;&quot; *
  00:41.99 &lt; * LIST (\HasNoChildren) &quot;.&quot; &quot;INBOX&quot;
  00:41.99 &lt; FNHG3 OK List completed.
('OK', ['(\\HasNoChildren) &quot;.&quot; &quot;INBOX&quot;'])
</pre>
</div>
<div class="slide" id="id27">
<h1>IMAP in Python</h1>
<p>We can find out about the mail on our server. We do this by querying for
<cite>status</cite>. IMAP provides a few different status values, let's ask for them
all:</p>
<pre class="literal-block">
&gt;&gt;&gt; vals = '(MESSAGES RECENT UIDNEXT'
&gt;&gt;&gt; vals += ' UIDVALIDITY UNSEEN)'
&gt;&gt;&gt; conn.status('INBOX', vals)
  12:03.91 &gt; FNHG4 STATUS INBOX (MESSAGES RECENT UIDNEXT UIDVALIDITY UNSEEN)
  12:04.01 &lt; * STATUS &quot;INBOX&quot; (MESSAGES 2 RECENT 0 UIDNEXT 3 UIDVALIDITY 1357449499 UNSEEN 1)
  12:04.01 &lt; FNHG4 OK Status completed.
('OK', ['&quot;INBOX&quot; (MESSAGES 2 RECENT 0
                  UIDNEXT 3 UIDVALIDITY 1357449499
                  UNSEEN 1)'])
</pre>
</div>
<div class="slide" id="id28">
<h1>IMAP in Python</h1>
<p>To interact with our email, we must select a mailbox from the list we received
earlier:</p>
<pre class="literal-block">
&gt;&gt;&gt; conn.select('INBOX')
  00:00.47 &gt; FNHG2 SELECT INBOX
  00:00.56 &lt; * FLAGS (\Answered \Flagged \Deleted \Seen \Draft)
  00:00.56 &lt; * OK [PERMANENTFLAGS (\Answered \Flagged \Deleted \Seen \Draft \*)] Flags permitted.
  00:00.56 &lt; * 2 EXISTS
  00:00.57 &lt; * 0 RECENT
  00:00.57 &lt; * OK [UNSEEN 2] First unseen.
  00:00.57 &lt; * OK [UIDVALIDITY 1357449499] UIDs valid
  00:00.57 &lt; * OK [UIDNEXT 3] Predicted next UID
  00:00.57 &lt; FNHG2 OK [READ-WRITE] Select completed.
('OK', ['2'])
</pre>
</div>
<div class="slide" id="id29">
<h1>IMAP in Python</h1>
<p>We can search our selected mailbox for messages matching one or more criteria.
The return value is a string list of the UIDs of messages that match our
search:</p>
<pre class="literal-block">
&gt;&gt;&gt; conn.search(None, '(FROM &quot;IPIP&quot;)')
  18:25.41 &gt; FNHG5 SEARCH (FROM &quot;IPIP&quot;)
  18:25.54 &lt; * SEARCH 1 2
  18:25.54 &lt; FNHG5 OK Search completed.
('OK', ['1 2'])
&gt;&gt;&gt;
</pre>
</div>
<div class="slide" id="id30">
<h1>IMAP in Python</h1>
<p>Once we've found a message we want to look at, we can use the <tt class="docutils literal">fetch</tt>
command to read it from the server. IMAP allows fetching each part of
a message independently:</p>
<pre class="literal-block">
&gt;&gt;&gt; conn.fetch('2', '(BODY[HEADER])')
...
&gt;&gt;&gt; conn.fetch('2', '(BODY[TEXT])')
...
&gt;&gt;&gt; conn.fetch('2', '(FLAGS)')
</pre>
</div>
<div class="slide" id="id31">
<h1>IMAP in Python</h1>
<p>It is even possible to download an entire message in raw format, and load that
into a python email message object:</p>
<pre class="literal-block">
&gt;&gt;&gt; import email
&gt;&gt;&gt; typ, data = conn.fetch('2', '(RFC822)')
  28:08.40 &gt; FNHG8 FETCH 2 (RFC822)
  ...
&gt;&gt;&gt; for part in data:
...   if isinstance(part, tuple):
...     msg = email.message_from_string(part[1])
...
&gt;&gt;&gt;
</pre>
</div>
<div class="slide" id="id32">
<h1>IMAP in Python</h1>
<p>Once we have that, we can play with the resulting email object:</p>
<pre class="literal-block">
&gt;&gt;&gt; msg['to']
'demo&#64;crisewing.com'
&gt;&gt;&gt; print msg.get_payload()
This is an email message
</pre>
</div>
<div class="slide" id="id33">
<h1>IMAP in Python</h1>
<p class="big-centered">Neat, huh?</p>
</div>
<div class="slide" id="what-have-we-learned">
<h1>What Have We Learned?</h1>
<ul class="incremental">
<li><p class="first">Protocols are just a set of rules for how to communicate</p>
</li>
<li><p class="first">A given protocol has a set of commands it knows</p>
</li>
<li><p class="first">If we properly format requests to a server, we can get answers</p>
</li>
<li><p class="first">Python supports a number of these protocols</p>
<blockquote>
<ul class="simple">
<li>So we don't have to remember how to format the commands ourselves</li>
</ul>
<ul class="incremental simple">
<li>But in every case we've seen so far, we could do the same thing with a
socket and some strings</li>
</ul>
</blockquote>
</li>
</ul>
</div>
<div class="slide" id="http">
<h1>HTTP</h1>
<p class="big-centered">HTTP is no different</p>
</div>
<div class="slide" id="id34">
<h1>HTTP</h1>
<p>We are concerned with two things in HTTP:</p>
<ul class="incremental simple">
<li>Requests (Asking for information)</li>
<li>Responses (Providing answers)</li>
</ul>
</div>
<div class="slide" id="http-req-resp-format">
<h1>HTTP Req/Resp Format</h1>
<p>Both share a common basic format:</p>
<ul class="incremental simple">
<li>Line separators are &lt;CRLF&gt;</li>
<li>An required initial line</li>
<li>A (mostly) optional set of headers, one per line</li>
<li>A blank line</li>
<li>An optional body</li>
</ul>
<p class="incremental">&quot;Be strict in what you send and tolerant in what you receive&quot;</p>
</div>
<div class="slide" id="http-requests">
<h1>HTTP Requests</h1>
<p>In HTTP 1.0, the only required line in an HTTP request is this:</p>
<pre class="literal-block">
GET /path/to/index.html HTTP/1.0
&lt;CRLF&gt;
</pre>
<p class="incremental">As virtual hosting grew more common, that was not enough, so HTTP 1.1 adds a
single required <em>header</em>, <strong>Host</strong>:</p>
<pre class="incremental literal-block">
GET /path/to/index.html HTTP/1.1
Host: www.mysite1.com:80
&lt;CRLF&gt;
</pre>
</div>
<div class="slide" id="http-verbs">
<h1>HTTP Verbs</h1>
<p><strong>GET</strong> <tt class="docutils literal">/path/to/index.html HTTP/1.1</tt></p>
<ul class="incremental">
<li><p class="first">Every HTTP request must start with a <em>verb</em></p>
</li>
<li><p class="first">There are four main HTTP verbs:</p>
<blockquote>
<ul class="incremental simple">
<li>GET</li>
<li>POST</li>
<li>PUT</li>
<li>DELETE</li>
</ul>
</blockquote>
</li>
</ul>
<ul class="incremental simple">
<li>There are others, notably HEAD, but you won't see them too much</li>
</ul>
</div>
<div class="slide" id="id35">
<h1>HTTP Verbs</h1>
<p>These four verbs are mapped to the four basic steps of a <em>CRUD</em> content management
cycle:</p>
<ul class="incremental simple">
<li>POST = Create</li>
<li>GET = Read</li>
<li>PUT = Update</li>
<li>DELETE = Delete</li>
</ul>
</div>
<div class="slide" id="verbs-safe-unsafe">
<h1>Verbs: Safe &lt;--&gt; Unsafe</h1>
<p>HTTP verbs can be categorized as <strong>safe</strong> or <strong>unsafe</strong>, based on whether they
might change something on the server:</p>
<ul class="incremental">
<li><dl class="first docutils">
<dt>Safe HTTP Verbs</dt>
<dd><ul class="first last simple">
<li>GET</li>
</ul>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>Unsafe HTTP Verbs</dt>
<dd><ul class="first last simple">
<li>POST</li>
<li>PUT</li>
<li>DELETE</li>
</ul>
</dd>
</dl>
</li>
</ul>
<p class="incremental">This is a <em>normative</em> distinction, which is to say <strong>be careful</strong></p>
</div>
<div class="slide" id="verbs-idempoent">
<h1>Verbs: Idempoent &lt;--&gt; ???</h1>
<p>HTTP verbs can be categorized as <strong>idempotent</strong>, based on whether a given
request will always have the same result:</p>
<ul class="incremental">
<li><dl class="first docutils">
<dt>Idempotent HTTP Verbs</dt>
<dd><ul class="first last simple">
<li>GET</li>
<li>PUT</li>
<li>DELETE</li>
</ul>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>Non-Idempotent HTTP Verbs</dt>
<dd><ul class="first last simple">
<li>POST</li>
</ul>
</dd>
</dl>
</li>
</ul>
<p class="incremental">Again, <em>normative</em>. The developer is responsible for ensuring that it is true.</p>
</div>
<div class="slide" id="http-requests-uri">
<h1>HTTP Requests: URI</h1>
<p><tt class="docutils literal">GET</tt> <strong>/path/to/index.html</strong> <tt class="docutils literal">HTTP/1.1</tt></p>
<ul class="incremental">
<li><p class="first">Every HTTP request must include a <strong>URI</strong> used to determine the <strong>resource</strong> to
be returned</p>
</li>
<li><p class="first">URI??
<a class="reference external" href="http://stackoverflow.com/questions/176264/whats-the-difference-between-a-uri-and-a-url/1984225#1984225">http://stackoverflow.com/questions/176264/whats-the-difference-between-a-uri-and-a-url/1984225#1984225</a></p>
</li>
<li><p class="first">Resource?  Files (html, img, .js, .css), but also:</p>
<blockquote>
<ul class="incremental simple">
<li>Dynamic scripts</li>
<li>Raw data</li>
<li>API endpoints</li>
</ul>
</blockquote>
</li>
</ul>
</div>
<div class="slide" id="http-responses">
<h1>HTTP Responses</h1>
<p>In both HTTP 1.0 and 1.1, a proper response consists of an intial line,
followed by optional headers, a single blank line, and then optionally a
response body:</p>
<pre class="literal-block">
HTTP/1.1 200 OK
Content-Type: text/plain
&lt;CRLF&gt;
this is a pretty minimal response
</pre>
</div>
<div class="slide" id="http-response-codes">
<h1>HTTP Response Codes</h1>
<p><tt class="docutils literal">HTTP/1.1</tt> <strong>200 OK</strong></p>
<p>All HTTP responses must include a <strong>response code</strong> indicating the outcome of
the request.</p>
<ul class="incremental simple">
<li>1xx (HTTP 1.1 only) - Informational message</li>
<li>2xx - Success of some kind</li>
<li>3xx - Redirection of some kind</li>
<li>4xx - Client Error of some kind</li>
<li>5xx - Server Error of some kind</li>
</ul>
<p class="incremental">The text bit makes the code more human-readable</p>
</div>
<div class="slide" id="common-response-codes">
<h1>Common Response Codes</h1>
<p>There are certain HTTP response codes you are likely to see (and use) most
often:</p>
<ul class="incremental simple">
<li><tt class="docutils literal">200 OK</tt> - Everything is good</li>
<li><tt class="docutils literal">301 Moved Permanently</tt> - You should update your link</li>
<li><tt class="docutils literal">304 Not Modified</tt> - You should load this from cache</li>
<li><tt class="docutils literal">404 Not Found</tt> - You've asked for something that doesn't exist</li>
<li><tt class="docutils literal">500 Internal Server Error</tt> - Something bad happened</li>
</ul>
<p class="incremental">Do not be afraid to use other, less common codes in building good RESTful
apps. There are a lot of them for a reason. See
<a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html">http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html</a></p>
</div>
<div class="slide" id="http-headers">
<h1>HTTP Headers</h1>
<p>Both requests and responses can contain <strong>headers</strong> of the form <tt class="docutils literal">Name: Value</tt></p>
<ul class="incremental simple">
<li>HTTP 1.0 has 16, 1.1 has 46</li>
<li>Any number of spaces or tabs may separate the <em>name</em> from the <em>value</em></li>
<li>If a header line starts with spaces or tabs, it is considered part of the
value for the previous header</li>
<li>Header <em>names</em> are <strong>not</strong> case-sensitive, but <em>values</em> may be</li>
</ul>
<p class="incremental">read more about HTTP headers: <a class="reference external" href="http://www.cs.tut.fi/~jkorpela/http.html">http://www.cs.tut.fi/~jkorpela/http.html</a></p>
</div>
<div class="slide" id="content-type-header">
<h1>Content-Type Header</h1>
<p>A very common header used in HTTP responses is <tt class="docutils literal"><span class="pre">Content-Type</span></tt>. It tells the
client what to expect.</p>
<ul class="incremental simple">
<li>uses <strong>mime-type</strong> (Multi-purpose Internet Mail Extensions)</li>
<li>foo.jpeg - <tt class="docutils literal"><span class="pre">Content-Type:</span> image/jpeg</tt></li>
<li>foo.png - <tt class="docutils literal"><span class="pre">Content-Type:</span> image/png</tt></li>
<li>bar.txt - <tt class="docutils literal"><span class="pre">Content-Type:</span> text/plain</tt></li>
<li>baz.html - <tt class="docutils literal"><span class="pre">Content-Type:</span> text/html</tt></li>
</ul>
<p class="incremental">There are <em>many</em> mime-type identifiers:
<a class="reference external" href="http://www.webmaster-toolkit.com/mime-types.shtml">http://www.webmaster-toolkit.com/mime-types.shtml</a></p>
</div>
<div class="slide" id="http-debugging">
<h1>HTTP Debugging</h1>
<p>When working on applications, it's nice to be able to see all this going back
and forth.  There are several apps that can help with this:</p>
<ul class="simple">
<li>windows: <a class="reference external" href="http://www.fiddler2.com/fiddler2/">http://www.fiddler2.com/fiddler2/</a></li>
<li>firefox: <a class="reference external" href="http://getfirebug.com/">http://getfirebug.com/</a></li>
<li>safari: built in</li>
<li>chrome: built in</li>
<li>IE (7.0+): built in</li>
</ul>
<p class="incremental">These tools can show you both request and response, headers and all. Very
useful.</p>
</div>
<div class="slide" id="lab-time">
<h1>Lab Time</h1>
<p>For this lab, we'll be building a basic HTTP server.</p>
<ul>
<li><p class="first">update your fork of the class repository by pulling from the <tt class="docutils literal">upstream</tt> remote</p>
</li>
<li><p class="first">find the folder <tt class="docutils literal">assignments/week02/lab</tt> and open <tt class="docutils literal">echo_server.py</tt></p>
<blockquote>
<ul class="simple">
<li>this is a canonical example of what we built last week</li>
</ul>
</blockquote>
</li>
<li><p class="first">We'll move in steps to turn this into an HTTP server.</p>
</li>
</ul>
</div>
<div class="slide" id="lab-time-step-1">
<h1>Lab Time - Step 1</h1>
<p>First, echo an HTTP request</p>
<ul class="simple">
<li>Run <cite>echo_server.py</cite> in a terminal</li>
<li>Point your browser at <tt class="docutils literal"><span class="pre">http://localhost:5000</span></tt>, what do you get back?</li>
<li>Save the script as <tt class="docutils literal">http_serve1.py</tt>, then edit it to make it return the
HTML you find in <tt class="docutils literal">tiny_html.html</tt></li>
<li>What does this look like?</li>
</ul>
</div>
<div class="slide" id="lab-time-step-2">
<h1>Lab Time - Step 2</h1>
<p>Return a proper HTTP response:</p>
<ul class="simple">
<li>Save the file as <tt class="docutils literal">http_serve2.py</tt></li>
<li>Add a new method that takes a string 'body' and returns a proper <tt class="docutils literal">200 OK</tt>
HTTP response.  Call the method <tt class="docutils literal">ok_response</tt>.</li>
<li>Bonus Points: add a GMT <tt class="docutils literal">Date:</tt> header in the proper format (RFC-1123).
<em>hint: see email.utils.formatdate in the python standard library</em></li>
<li>How does the returned HTML look now?</li>
</ul>
</div>
<div class="slide" id="lab-time-step-3">
<h1>Lab Time - Step 3</h1>
<p>Parse an incoming request to get the URI:</p>
<ul class="simple">
<li>Save the file as <tt class="docutils literal">http_serve3.py</tt></li>
<li>Add a new method called <tt class="docutils literal">parse_request</tt> that takes a request and returns a
URI. Have the server print the URI to the console (rudimentary logging).</li>
<li>Make sure that the method validates that the incoming request is HTTP and
that the verb is <tt class="docutils literal">GET</tt>. If either is not true, it should raise a
ValueError</li>
<li>Bonus points: add an <tt class="docutils literal">client_error_response</tt> method that returns an
appropriate HTTP code if the validation from <tt class="docutils literal">parse_request</tt> fails. What
is the right response code?</li>
</ul>
</div>
<div class="slide" id="lab-time-step-4">
<h1>Lab Time - Step 4</h1>
<p>Serve directory listings:</p>
<ul>
<li><p class="first">Save the file as <tt class="docutils literal">http_serve4.py</tt> * Add a method called <tt class="docutils literal">resolve_uri</tt>
which takes as an argument the URI returned from our previous step and
returns an HTTP response. The method should start from a given directory
('web') and check the URI:</p>
<blockquote>
<ul class="simple">
<li>If the URI names a directory, return the content listing as a <tt class="docutils literal">200 OK</tt></li>
<li>If the URI names a file, raise a NotImplementedError (coming soon)</li>
<li>If the URI does not exist, raise a ValueError</li>
</ul>
</blockquote>
</li>
<li><p class="first">Bonus points: add a <tt class="docutils literal">notfound_response</tt> method that returns a proper <tt class="docutils literal">404
Not Found</tt> response to the client. Use it when appropriate. (where is
that?)</p>
</li>
</ul>
</div>
<div class="slide" id="lab-time-step-5">
<h1>Lab Time - Step 5</h1>
<p>Serve different types of files:</p>
<ul class="simple">
<li>Save the file as <tt class="docutils literal">http_serve5.py</tt></li>
<li>Update the <tt class="docutils literal">resolve_uri</tt> method. If the URI names a file, return it as the
body of a <tt class="docutils literal">200 OK</tt> response.</li>
<li>You'll need a way to return the approprate <tt class="docutils literal"><span class="pre">Content-Type:</span></tt> header.</li>
<li>Support at least <tt class="docutils literal">.html</tt>, <tt class="docutils literal">.txt</tt>, <tt class="docutils literal">.jpeg</tt>, and <tt class="docutils literal">.png</tt> files</li>
<li>Try it out.</li>
</ul>
<p class="incremental">You've now got a reasonably functional HTTP web server.  Congratulations!</p>
</div>
<div class="slide" id="assignment">
<h1>Assignment</h1>
<p>Using what you've learned this week, take your new webserver to the next
level. Accomplish as many of the following as you can:</p>
<ul class="simple">
<li>If you were unable to complete the first five steps in class, circle back
and finish them</li>
<li>Complete the 'Bonus point' parts from the first five steps, if you haven't
already done so</li>
<li>Format your directory listing as HTML</li>
<li>In the HTML directory listing, make the files clickable links</li>
<li>Add a new, dynamic endpoint. If the URI /time-page is requested, return an
HTML page with the current time displayed.</li>
</ul>
</div>
<div class="slide" id="submitting-the-assignment">
<h1>Submitting the Assignment</h1>
<ul class="simple">
<li>Copy your final html server into the <tt class="docutils literal">assignments/week02/athome</tt>
directory in your fork of the repository.</li>
<li>Copy the <tt class="docutils literal">assignments/week02/lab/web</tt> directory into
<tt class="docutils literal">assignments/week02/at_home</tt></li>
<li>Make a new plain-text file at the top level of the web directory. Tell me
what you did in it.</li>
<li>Make a new pull request for the week02 assignments.</li>
<li>I should be able to run the server on my local machine, open your plain text
file in my browser, and evaluate your work from there.</li>
<li>For bonus points, set the server running on your VM, with the <tt class="docutils literal">web</tt> home
directory. I should be able to load <a class="reference external" href="http://yourserver.bluboxgrid.com:50000">http://yourserver.bluboxgrid.com:50000</a>
in my web browser and evaluate your results.</li>
</ul>
</div>
<div class="slide" id="lightning-talks">
<h1>Lightning Talks</h1>
<p class="big-centered">Ready, Steady, GO!</p>
</div>
</div>
</body>
</html>
