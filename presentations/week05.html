<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.9.1: http://docutils.sourceforge.net/" />
<meta name="version" content="S5 1.1" />
<title>Internet Programming with Python</title>
<link rel="stylesheet" href="ui/uw_pce_theme/pretty.css" type="text/css" />
<!-- configuration parameters -->
<meta name="defaultView" content="slideshow" />
<meta name="controlVis" content="hidden" />
<!-- style sheet links -->
<script src="ui/uw_pce_theme/slides.js" type="text/javascript"></script>
<link rel="stylesheet" href="ui/uw_pce_theme/slides.css"
      type="text/css" media="projection" id="slideProj" />
<link rel="stylesheet" href="ui/uw_pce_theme/outline.css"
      type="text/css" media="screen" id="outlineStyle" />
<link rel="stylesheet" href="ui/uw_pce_theme/print.css"
      type="text/css" media="print" id="slidePrint" />
<link rel="stylesheet" href="ui/uw_pce_theme/opera.css"
      type="text/css" media="projection" id="operaFix" />
</head>
<body>
<div class="layout">
<div id="controls"></div>
<div id="currentSlide"></div>
<div id="header">

</div>
<div id="footer">
<h1>Internet Programming with Python</h1>
<h2><a class="reference external" href="http://github.com/cewing/training.python_web">View document source</a>.
</h2>
</div>
</div>
<div class="presentation">
<div class="slide" id="slide0">
<h1 class="title">Internet Programming with Python</h1>

<img alt="img/bike.jpg" class="align-left" src="img/bike.jpg" style="width: 50%;" />
<p>Week 5: Small Frameworks</p>
<div class="intro-blurb right line-block">
<div class="line">&quot;Reinventing the wheel is great</div>
<div class="line">if your goal is to learn more about the wheel&quot;</div>
<div class="line"><br /></div>
<div class="line">-- James Tauber, PyCon 2007</div>
</div>
<p class="image-credit">image: Britanglishman <a class="reference external" href="http://www.flickr.com/photos/britanglishman/5999131365/">http://www.flickr.com/photos/britanglishman/5999131365/</a> - CC-BY</p>

</div>
<div class="slide" id="but-first">
<h1>But First</h1>
<p class="big-centered">Review from the Assignment</p>
</div>
<div class="slide" id="url-mapping">
<h1>URL Mapping</h1>
<p>Two basic approaches to solving the problem:</p>
<pre class="literal-block">
/books?id=id1
/books/id1
</pre>
<p class="incremental">The first generally used <tt class="docutils literal"><span class="pre">environ['QUERY_STRING']</span></tt>. The second used
<tt class="docutils literal"><span class="pre">environ['PATH_INFO']</span></tt></p>
<p class="incremental">Both are fine. Largely a matter of taste. I find the latter more common in
daily work.</p>
</div>
<div class="slide" id="regular-expressions">
<h1>Regular Expressions</h1>
<p>My personal approach to the url mapping problem was the second, which relies
on regular expression mapping:</p>
<pre class="code python literal-block">
<span class="n">URLS</span> <span class="o">=</span> <span class="p">[(</span><span class="s">r'^$'</span><span class="p">,</span> <span class="s">'books'</span><span class="p">),</span>
        <span class="p">(</span><span class="s">r'^book/(id[\d]{1,2})$'</span><span class="p">,</span> <span class="s">'book'</span><span class="p">),</span> <span class="p">]</span>
</pre>
<p class="incremental">Regular expressions should be as tight as possible, it's easy to over-match</p>
<p class="incremental">Read the <a class="reference external" href="http://docs.python.org/2.6/howto/regex.html">Python Regexp How-to</a>
and find a good <a class="reference external" href="http://www.pythonregex.com/">Regular Expression Tester</a></p>
</div>
<div class="slide" id="string-formatting">
<h1>String Formatting</h1>
<p>This is awkward:</p>
<pre class="code python literal-block">
<span class="n">bob</span> <span class="o">=</span> <span class="p">{</span><span class="s">'a'</span><span class="p">:</span> <span class="s">'things'</span><span class="p">,</span> <span class="s">'b'</span><span class="p">:</span> <span class="s">'stuff'</span><span class="p">}</span>
<span class="s">&quot;I have lots of &quot;</span> <span class="o">+</span> <span class="n">bob</span><span class="p">[</span><span class="s">'a'</span><span class="p">]</span> <span class="o">+</span> <span class="s">&quot; and &quot;</span> <span class="o">+</span> <span class="n">bob</span><span class="p">[</span><span class="s">'b'</span><span class="p">]</span> <span class="o">+</span> <span class="s">&quot;.&quot;</span>
</pre>
<p class="incremental">This is much less so:</p>
<pre class="code python incremental literal-block">
<span class="n">bob</span> <span class="o">=</span> <span class="p">{</span><span class="s">'a'</span><span class="p">:</span> <span class="s">'things'</span><span class="p">,</span> <span class="s">'b'</span><span class="p">:</span> <span class="s">'stuff'</span><span class="p">}</span>
<span class="s">&quot;I have lots of </span><span class="si">%(a)s</span><span class="s"> and </span><span class="si">%(b)s</span><span class="s">.&quot;</span> <span class="o">%</span> <span class="n">bob</span>
</pre>
<p class="incremental">I am chastened.  string.format() is the best (most flexible)</p>
</div>
<div class="slide" id="wsgiscriptalias">
<h1>WSGIScriptAlias</h1>
<p>CGI required a cgi directory.  WSGI makes no such requirement.</p>
<p class="incremental">You can use WSGIScriptAlias to point to a single file</p>
<p class="incremental">Since a single file can often provide the entry point to an entire app, this
allows you to mount entire apps at arbitrary path locations:</p>
<pre class="incremental literal-block">
WSGIScriptAlias / /path/to/main/app/wsgi_app.py
WSGIScriptAlias /blog /path/to/blog/app/wsgi_app.py
WSGIScriptAlias /forum /path/to/forum/app/wsgi_app.py
</pre>
</div>
<div class="slide" id="bad-html">
<h1>Bad HTML</h1>
<p>I know that web browsers are forgiving, but you should be less so.</p>
<p>These are <em>not</em> good HTML:</p>
<pre class="literal-block">
&lt;p&gt;&lt;a href = /book/id4 &gt;foobar&lt;/p&gt;
&lt;P&gt;&lt;A HREF='/book/id4'&gt;foobar&lt;/A&gt;&lt;/P&gt;
</pre>
<p class="incremental">This is: <cite>&lt;p&gt;&lt;a href=&quot;/book/id4&quot;&gt;foobar&lt;/a&gt;&lt;/p&gt;</cite></p>
<p class="incremental">The <a class="reference external" href="https://developer.mozilla.org/en-US/docs/HTML">Mozilla Developer Network</a> is a great resource for
proper HTML. It also has great reference information on JavaScript. Shun the
<cite>w3schools</cite>.</p>
</div>
<div class="slide" id="and-second">
<h1>And Second</h1>
<p class="big-centered">Questions from the Reading?</p>
</div>
<div class="slide" id="and-third">
<h1>And Third</h1>
<p class="center incremental"><strong>Class Project</strong></p>
<ul class="incremental simple">
<li>Create a Website</li>
<li>It can do anything you want it to.</li>
<li>It should have some user interactions (forms users complete).</li>
<li>It should look nice-ish</li>
<li>It should show off some aspect of what you've learned</li>
<li>It should take you about 15-20 hours to create (so small)</li>
<li>It will be due Friday following the last day of class (March 15)</li>
<li>We will spend half of each of the last two class session working on it in
class.</li>
<li><strong>Questions?</strong></li>
</ul>
</div>
<div class="slide" id="and-now">
<h1>And Now...</h1>
<p class="big-centered">Small Frameworks</p>
</div>
<div class="slide" id="a-moment-to-reflect">
<h1>A Moment to Reflect</h1>
<p>We've been at this for a while now.  We've learned a great deal:</p>
<ul class="incremental simple">
<li>Sockets, the TCP/IP Stack and Basic Mechanics</li>
<li>Web Protocols and the Importance of Clear Communication</li>
<li>APIs and Consuming Data from The Web</li>
<li>CGI and WSGI and Getting Information to Your Dynamic Applications</li>
</ul>
<p class="incremental">This concludes the foundational part of the course.</p>
<p class="incremental">Everything we do from here out will be based on tools built using what we've
learned these first four weeks.</p>
</div>
<div class="slide" id="we-ve-built">
<h1>We've built</h1>
<p class="big-centered">A full-featured web server</p>
</div>
<div class="slide" id="id1">
<h1>We've built</h1>
<p class="big-centered">Data-driven applications using web-based APIs</p>
</div>
<div class="slide" id="id2">
<h1>We've built</h1>
<p class="big-centered">CGI web pages</p>
</div>
<div class="slide" id="id3">
<h1>We've built</h1>
<p class="big-centered">A simple wsgi application</p>
</div>
<div class="slide" id="onward">
<h1>Onward</h1>
<p class="big-centered">We are moving up the stack</p>
</div>
<div class="slide" id="from-now-on">
<h1>From Now On</h1>
<p>Think of everything we do as sitting on top of WSGI</p>
<p class="incremental">This may not <em>actually</em> be true</p>
<p class="incremental">But we will always be working at that level of abstraction.</p>
</div>
<div class="slide" id="the-abstraction-stack">
<h1>The Abstraction Stack</h1>
<p>You can think of the libraries we use to write web applications as belonging
to one of several levels:</p>
<p class="incremental center">plumbing</p>
<p class="incremental center">tools</p>
<p class="incremental center">small frameworks</p>
<p class="incremental center">full-stack frameworks</p>
<p class="incremental center">systems</p>
</div>
<div class="slide" id="plumbing">
<h1>Plumbing</h1>
<p>We've done this part already:</p>
<p class="center">Sockets</p>
<p class="center">Protocols</p>
<p class="center">CGI/WSGI</p>
</div>
<div class="slide" id="tools">
<h1>Tools</h1>
<p>We've started to talk about these, we'll see more soon:</p>
<p class="center">cgitb</p>
<p class="center">wsgi middleware</p>
<p class="center">werkzeug tools</p>
<p class="center">WebOb</p>
</div>
<div class="slide" id="small-frameworks">
<h1>Small Frameworks</h1>
<p>We're here today:</p>
<p class="center">Flask</p>
<p class="center">Bottle</p>
<p class="center">CherryPy</p>
<p class="center">Web.py</p>
<p class="center">and many many more...</p>
</div>
<div class="slide" id="full-stack-frameworks">
<h1>Full Stack Frameworks</h1>
<p>We will visit this level next:</p>
<p class="center">Django</p>
<p class="center">Pyramid</p>
<p class="center">web2py</p>
</div>
<div class="slide" id="systems">
<h1>Systems</h1>
<p>We'll finish up here</p>
<p class="center">Plone</p>
</div>
<div class="slide" id="frameworks">
<h1>Frameworks</h1>
<p>From Wikipedia:</p>
<p class="center incremental">A web application framework (WAF) is a software framework that is designed to
support the development of dynamic websites, web applications and web
services. The framework aims to alleviate the overhead associated with common
activities performed in Web development. For example, many frameworks provide
libraries for database access, templating frameworks and session management,
and they often promote code reuse</p>
</div>
<div class="slide" id="what-does-that-mean">
<h1>What Does That <em>Mean</em>?</h1>
<p>You use a framework to build an application.</p>
<p class="incremental">A framework allows you to build different kinds of applications.</p>
<p class="incremental">A framework abstracts what needs to be abstracted, and allows control of the
rest.</p>
<p class="incremental">Think back over the last four weeks. What were your pain points? Which bits do
you wish you didn't have to think about?</p>
</div>
<div class="slide" id="level-of-abstraction">
<h1>Level of Abstraction</h1>
<p>This last part is important when it comes to choosing a framework</p>
<ul class="incremental simple">
<li>abstraction ∝ 1/freedom</li>
<li>The more they choose, the less you can</li>
<li><em>Every</em> framework makes choices in what to abstract</li>
<li><em>Every</em> framework makes <em>different</em> choices</li>
</ul>
</div>
<div class="slide" id="python-web-frameworks">
<h1>Python Web Frameworks</h1>
<p>There are scores of 'em (this is a partial list).</p>
<table border="1" class="incremental invisible small center docutils">
<colgroup>
<col width="18%" />
<col width="16%" />
<col width="16%" />
<col width="20%" />
<col width="29%" />
</colgroup>
<tbody valign="top">
<tr><td>Django</td>
<td>Grok</td>
<td>Pylons</td>
<td>TurboGears</td>
<td>web2py</td>
</tr>
<tr><td>Zope</td>
<td>CubicWeb</td>
<td>Enamel</td>
<td>Gizmo(QP)</td>
<td>Glashammer</td>
</tr>
<tr><td>Karrigell</td>
<td>Nagare</td>
<td>notmm</td>
<td>Porcupine</td>
<td>QP</td>
</tr>
<tr><td>SkunkWeb</td>
<td>Spyce</td>
<td>Tipfy</td>
<td>Tornado</td>
<td>WebCore</td>
</tr>
<tr><td>web.py</td>
<td>Webware</td>
<td>Werkzeug</td>
<td>WHIFF</td>
<td>XPRESS</td>
</tr>
<tr><td>AppWsgi</td>
<td>Bobo</td>
<td>Bo7le</td>
<td>CherryPy</td>
<td>circuits.web</td>
</tr>
<tr><td>Paste</td>
<td>PyWebLib</td>
<td>WebStack</td>
<td>Albatross</td>
<td>Aquarium</td>
</tr>
<tr><td>Divmod</td>
<td>Nevow</td>
<td>Flask</td>
<td>JOTWeb2</td>
<td>Python Servlet</td>
</tr>
<tr><td>Engine</td>
<td>Pyramid</td>
<td>Quixote</td>
<td>Spiked</td>
<td>weblayer</td>
</tr>
</tbody>
</table>
</div>
<div class="slide" id="choosing-a-framework">
<h1>Choosing a Framework</h1>
<p>Many folks will tell you &quot;&lt;XYZ&gt; is the <strong>best</strong> framework&quot;.</p>
<p class="incremental">In most cases, what they really mean is &quot;I know how to use &lt;XYZ&gt;&quot;</p>
<p class="incremental">In some cases, what they really mean is &quot;&lt;XYZ&gt; fits my brain the best&quot;</p>
<p class="incremental">What they usually forget is that everyone's brain (and everyone's use-case) is
different.</p>
</div>
<div class="slide" id="cris-first-law-of-frameworks">
<h1>Cris' First Law of Frameworks</h1>
<p class="center"><strong>Pick the Right Tool for the Job</strong></p>
<p class="incremental">First Corollary</p>
<p class="incremental center">The right tool is the tool that allows you to finish the job quickly and
correctly.</p>
<p class="incremental center">But how do you know which that one is?</p>
</div>
<div class="slide" id="cris-second-law-of-frameworks">
<h1>Cris' Second Law of Frameworks</h1>
<p class="big-centered">You can't know unless you try</p>
<p class="incremental center">so let's try</p>
</div>
<div class="slide" id="preparation">
<h1>Preparation</h1>
<p>We proceed under the assumption that you have installed Flask into a
virtualenv, either on your laptop or on your VM.</p>
<p class="incremental">Start by activating the virtualenv with Flask installed.  Mine is 'flaskenv'.</p>
<p class="incremental">Next, create a new python source file: <tt class="docutils literal">flask_intro.py</tt></p>
<p class="incremental">Finally, open that file in your text editor</p>
</div>
<div class="slide" id="flask">
<h1>Flask</h1>
<p>Getting started with Flask is pretty straightforward. Here's a complete,
simple app.  Type it into <cite>flask_intro.py</cite>:</p>
<pre class="code python small literal-block">
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

<span class="nd">&#64;app.route</span><span class="p">(</span><span class="s">'/'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">hello_world</span><span class="p">():</span>
    <span class="k">return</span> <span class="s">'Hello World!'</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre>
</div>
<div class="slide" id="running-our-app">
<h1>Running our App</h1>
<p>As you might expect by now, the last block in our <tt class="docutils literal">flask_intro.py</tt> file
allows us to run this as a python program. Save your file, and in your
terminal try this:</p>
<pre class="literal-block">
(flaskenv)$ python flask_intro.py
</pre>
<p class="incremental">Load <tt class="docutils literal"><span class="pre">http://localhost:5000</span></tt> in your browser to see it in action.</p>
</div>
<div class="slide" id="debugging-our-app">
<h1>Debugging our App</h1>
<p>Last week, <tt class="docutils literal">cgitb</tt> provided us with useful feedback when building an app.
Flask has a similar tool. Make the following changes to your
<tt class="docutils literal">flask_intro.py</tt> file:</p>
<pre class="code python small literal-block">
<span class="nd">&#64;app.route</span><span class="p">(</span><span class="s">'/'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">hello_world</span><span class="p">():</span>
    <span class="n">bar</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="s">'Hello World!'</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre>
<p>In your terminal, quit the app with <tt class="docutils literal">^C</tt> and then restart it. Then reload
your browser and see what happens.</p>
</div>
<div class="slide" id="what-s-happening-here">
<h1>What's Happening Here?</h1>
<p>Flask the framework provides a Python class called <cite>Flask</cite>. This class
represents a single <em>application</em> in the WSGI sense.</p>
<ul class="incremental simple">
<li>You instantiate a <cite>Flask</cite> app with a name that represents the package or
module containing the app.</li>
<li>If your application is a single module, this should be <cite>__name__</cite></li>
<li>This is used to help the <cite>Flask</cite> app figure out where to look for
<em>resources</em></li>
<li><em>Resources</em> can be static files (css, images, javascript), templates, or
additional python modules you create and need to import.</li>
<li>You define a function and route a URL to call it</li>
</ul>
</div>
<div class="slide" id="url-routing">
<h1>URL Routing</h1>
<p>Remember our bookdb homework? How did you end up solving the problem of
mapping an HTTP request to the right function?</p>
<p class="incremental">Flask solves this problem by using the <cite>route</cite> decorator from your app.</p>
<p class="incremental">A 'route' takes a URL rule (more on that in a minute) and maps it to an
<em>endpoint</em> and a <em>function</em>.</p>
<p class="incremental">When a request arrives at a URL that matches a known rule, the function is
called.</p>
</div>
<div class="slide" id="routes-can-be-dynamic">
<h1>Routes Can Be Dynamic</h1>
<p>You can provide <em>placeholders</em> in dynamic urls. Each <em>placeholder</em> is then a
named arg to your function (add these to <tt class="docutils literal">flask_intro.py</tt> (and delete the
1/0 bit)):</p>
<pre class="code python incremental small literal-block">
<span class="nd">&#64;app.route</span><span class="p">(</span><span class="s">'/profile/&lt;username&gt;'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">show_profile</span><span class="p">(</span><span class="n">username</span><span class="p">):</span>
    <span class="k">return</span> <span class="s">&quot;My username is </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">username</span>
</pre>
<p class="incremental">These <em>placeholders</em> can also include <em>converters</em> that will ensure the
incoming argument is of the correct type.</p>
<pre class="code python incremental small literal-block">
<span class="nd">&#64;app.route</span><span class="p">(</span><span class="s">'/div/&lt;float:val&gt;/'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">divide</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
    <span class="k">return</span> <span class="s">&quot;</span><span class="si">%0.2f</span><span class="s"> divided by 2 is </span><span class="si">%0.2f</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">val</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
</pre>
</div>
<div class="slide" id="routes-can-be-filtered">
<h1>Routes Can Be Filtered</h1>
<p>You can also determine which HTTP <em>methods</em> a given route will accept:</p>
<pre class="code python small literal-block">
<span class="nd">&#64;app.route</span><span class="p">(</span><span class="s">'/blog/entry/&lt;int:id&gt;/'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">'GET'</span><span class="p">,])</span>
<span class="k">def</span> <span class="nf">read_entry</span><span class="p">(</span><span class="nb">id</span><span class="p">):</span>
    <span class="k">return</span> <span class="s">&quot;reading entry </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">id</span>

<span class="nd">&#64;app.route</span><span class="p">(</span><span class="s">'/blog/entry/&lt;int:id&gt;/'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">'POST'</span><span class="p">,</span> <span class="p">])</span>
<span class="k">def</span> <span class="nf">write_entry</span><span class="p">(</span><span class="nb">id</span><span class="p">):</span>
    <span class="k">return</span> <span class="s">'writing entry </span><span class="si">%d</span><span class="s">'</span> <span class="o">%</span> <span class="nb">id</span>
</pre>
<p class="incremental">After adding that to <tt class="docutils literal">flask_intro.py</tt> and saving, try loading
<tt class="docutils literal"><span class="pre">http://localhost:5000/blog/entry/23/</span></tt> into your browser. Which was called?</p>
</div>
<div class="slide" id="routes-can-be-reversed">
<h1>Routes Can Be Reversed</h1>
<p>Reversing a URL means the ability to generate the url that would result in a
given endpoint being called.</p>
<p class="incremental">This means <em>you don't have to hard-code your URLs when building links</em></p>
<p class="incremental">That means <em>you can change the URLs for your app without changing code or
templates</em></p>
<p class="incremental">This is called <strong>decoupling</strong> and it is a good thing</p>
</div>
<div class="slide" id="reversing-urls-in-flask">
<h1>Reversing URLs in Flask</h1>
<p>In Flask, you reverse a url with the <tt class="docutils literal">url_for</tt> function.</p>
<ul class="incremental simple">
<li><tt class="docutils literal">url_for</tt> requires an HTTP request context to work</li>
<li>You can fake an HTTP request when working in a terminal (or testing)</li>
<li>Use the <tt class="docutils literal">test_request_context</tt> method of your app object</li>
<li>This is a great chance to learn about the Python <tt class="docutils literal">with</tt> statement</li>
<li><strong>Don't type this</strong></li>
</ul>
<pre class="code python small incremental literal-block">
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">url_for</span>
<span class="k">with</span> <span class="n">app</span><span class="o">.</span><span class="n">test_request_context</span><span class="p">():</span>
  <span class="k">print</span> <span class="n">url_for</span><span class="p">(</span><span class="s">'endpoint'</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre>
</div>
<div class="slide" id="reversing-in-action">
<h1>Reversing in Action</h1>
<p>Quit your Flask app with <tt class="docutils literal">^C</tt>.  Then start a python interpreter in that same
terminal and import your <tt class="docutils literal">flask_intro.py</tt> module:</p>
<pre class="code python literal-block">
<span class="kn">import</span> <span class="nn">flask_intro</span>
<span class="kn">from</span> <span class="nn">flask_intro</span> <span class="kn">import</span> <span class="n">app</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">url_for</span>
<span class="k">with</span> <span class="n">app</span><span class="o">.</span><span class="n">test_request_context</span><span class="p">():</span>
    <span class="k">print</span> <span class="n">url_for</span><span class="p">(</span><span class="s">'show_profile'</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="s">&quot;cris&quot;</span><span class="p">)</span>
    <span class="k">print</span> <span class="n">url_for</span><span class="p">(</span><span class="s">'divide'</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="mf">23.7</span><span class="p">)</span>

<span class="s">'/profile/cris/'</span>
<span class="s">'/div/23.7/'</span>
</pre>
</div>
<div class="slide" id="generating-html">
<h1>Generating HTML</h1>
<p class="big-centered">I enjoy writing building HTML in Python strings</p>
<p class="incremental right">-- nobody, ever</p>
</div>
<div class="slide" id="templating">
<h1>Templating</h1>
<p>A good framework will provide some way of generating HTML with a templating
system.</p>
<p class="incremental">There are nearly as many templating systems as there are frameworks</p>
<p class="incremental">Each has advantages and disadvantages</p>
<p class="incremental">Flask includes the <em>Jinja2</em> templating system (perhaps because it's built by
the same folks)</p>
</div>
<div class="slide" id="jinja2-template-basics">
<h1>Jinja2 Template Basics</h1>
<p>There are a few basic things to know:</p>
<ul class="incremental simple">
<li>Variables in templates can be printed by surrounding the variable name with
double curly braces: <tt class="docutils literal">{{ name }}</tt>.</li>
<li>If a variable points to something like a dictionary or object, you can use
<em>either</em> dot or subscript notation: <tt class="docutils literal">{{ obj[attr] }}</tt>, <tt class="docutils literal">{{ dict.key
}}</tt>.</li>
<li>Variables in templates can be <em>filtered</em>: <tt class="docutils literal">{{ name|capitalize }}</tt>. There
is a list of builtin filters.</li>
<li>Logic can be put into templates using the processor marker: <tt class="docutils literal">{% for x in y
<span class="pre">%}{{</span> x <span class="pre">}}{%</span> endfor %}</tt></li>
<li>Logic comes in pairs.  Any start <em>must</em> have an explicit end.</li>
</ul>
</div>
<div class="slide" id="advanced-jinja2">
<h1>Advanced Jinja2</h1>
<p>There is <em>way</em> too much about writing templates in Jinja2 for us to cover here
today. Read more here:</p>
<p class="center"><a class="reference external" href="http://jinja.pocoo.org/docs/templates/">http://jinja.pocoo.org/docs/templates/</a></p>
</div>
<div class="slide" id="templates-in-flask">
<h1>Templates in Flask</h1>
<p>Use the <tt class="docutils literal">render_template</tt> function:</p>
<pre class="code python small literal-block">
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">render_template</span>

<span class="nd">&#64;app.route</span><span class="p">(</span><span class="s">'/hello/'</span><span class="p">)</span>
<span class="nd">&#64;app.route</span><span class="p">(</span><span class="s">'/hello/&lt;name&gt;'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">hello</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">'hello.html'</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
</pre>
<p class="incremental">Flask looks for a <tt class="docutils literal">templates</tt> directory in the same location as your app
module (remember <tt class="docutils literal">app = Flask(__name__)</tt>?).</p>
<p class="incremental">Any extra variables you want to pass to the template should be keyword
arguments to <tt class="docutils literal">render_template</tt></p>
</div>
<div class="slide" id="flask-template-context">
<h1>Flask Template Context</h1>
<p>Flask adds a few things to the context of templates.  You can use these</p>
<ul class="incremental simple">
<li><strong>config</strong>: contains the current configuration object</li>
<li><strong>request</strong>: contains the current request object</li>
<li><strong>session</strong>: any session data that might be available</li>
<li><strong>g</strong>: the request-local object to which global variables are bound</li>
<li><strong>get_flashed_messages</strong>: a function that returns messages you flash to your
users (more on this later).</li>
<li><strong>url_for</strong>: so you can easily <em>reverse</em> urls from within your templates</li>
</ul>
</div>
<div class="slide" id="lab-1">
<h1>Lab 1</h1>
<p>Open a terminal, change directories to the class repository, then to
<tt class="docutils literal">assignments/week05/lab/book_app</tt>.</p>
<ul class="incremental simple">
<li>You'll find a file <tt class="docutils literal">book_app.py</tt> which is all set up and ready to go</li>
<li>You'll also find a <tt class="docutils literal">templates</tt> directory with some templates</li>
<li>Complete the functions to provide the right stuff to the templates</li>
<li>Complete the templates to display the data to the end-user</li>
<li>At the end you should have a reproduced version of last week's homework</li>
</ul>
<p class="incremental center"><strong>GO</strong></p>
</div>
<div class="slide" id="lab-2-part-1">
<h1>Lab 2 - Part 1</h1>
<p>The rest of class today will be devoted to building and deploying a simple
micro-blog app using flask.</p>
<p class="incremental">This is based almost entirely on the <a class="reference external" href="http://flask.pocoo.org/docs/tutorial/">Flaskr tutorial</a> from the Flask website.</p>
</div>
<div class="slide" id="data-persistence">
<h1>Data Persistence</h1>
<p>There are many models for persistance of data.</p>
<ul class="incremental simple">
<li>Flat files</li>
<li>Relational Database (SQL RDBMs like PostgreSQL, MySQL, SQLServer, Oracle)</li>
<li>Object Stores (Pickle, ZODB)</li>
<li>NoSQL Databases (CouchDB, MongoDB, etc)</li>
</ul>
<p class="incremental">It's also one of the most contentious issues in app design.</p>
<p class="incremental">For this reason, it's one of the things that most Small Frameworks leave
undecided.</p>
</div>
<div class="slide" id="simple-sql">
<h1>Simple SQL</h1>
<p>For our second lab exercise today, we're going to use a simple SQL database.</p>
<p class="incremental">Python <a class="reference external" href="http://www.python.org/dev/peps/pep-0249/">PEP 249</a> describes a
common API for database connections called DB API.</p>
<p class="incremental">The Python Standard Library comes with an implementation of this for a common,
light-weight sql database, sqlite3</p>
<p class="incremental">I am <em>not</em> going to talk a lot about SQL.  It's too deep a pool for us to get
into.  We'll concentrate only on those bits we need to get along.</p>
</div>
<div class="slide" id="our-database">
<h1>Our Database</h1>
<p>We're going to keep this really really simple.</p>
<p class="incremental">In <tt class="docutils literal">assignments/week05/lab/</tt> find the <tt class="docutils literal">flaskr_1</tt> directory and open the
<tt class="docutils literal">schema.sql</tt> file in your editor. Add the following and save the file:</p>
<pre class="code sql incremental literal-block">
<span class="k">drop</span> <span class="k">table</span> <span class="n">if</span> <span class="k">exists</span> <span class="n">entries</span><span class="p">;</span>
<span class="k">create</span> <span class="k">table</span> <span class="n">entries</span> <span class="p">(</span>
    <span class="n">id</span> <span class="nb">integer</span> <span class="k">primary</span> <span class="k">key</span> <span class="n">autoincrement</span><span class="p">,</span>
    <span class="n">title</span> <span class="n">string</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
    <span class="nb">text</span> <span class="n">string</span> <span class="k">not</span> <span class="k">null</span>
<span class="p">);</span>
</pre>
</div>
<div class="slide" id="our-app">
<h1>Our App</h1>
<p>We'll also need to do some configuration for our app.</p>
<p class="incremental">In that same directory, find the file <tt class="docutils literal">flaskr.py</tt> and open it in your
editor. Add the following and save the file:</p>
<pre class="code python incremental literal-block">
<span class="c"># configuration goes here</span>
<span class="n">DATABASE</span> <span class="o">=</span> <span class="s">'/tmp/flaskr.db'</span>
<span class="n">SECRET_KEY</span> <span class="o">=</span> <span class="s">'development key'</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span> <span class="c"># this is already in the file</span>
<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">from_object</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
</pre>
<p class="incremental small"><strong>Windows users, you will need to create C:\tmp or change the pathname for
DATABASE</strong></p>
</div>
<div class="slide" id="creating-the-database">
<h1>Creating the Database</h1>
<p>Still in <tt class="docutils literal">flaskr.py</tt> let's add a function that will connect to our database:</p>
<pre class="code python incremental literal-block">
<span class="c"># add this at the very top</span>
<span class="kn">import</span> <span class="nn">sqlite3</span>

<span class="c"># add the rest of this below the app.config statement</span>
<span class="k">def</span> <span class="nf">connect_db</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">'DATABASE'</span><span class="p">])</span>
</pre>
<p class="incremental">This will be a convenience to us later on, and it will allow us to write our
very first test.</p>
</div>
<div class="slide" id="tests-and-tdd">
<h1>Tests and TDD</h1>
<p class="center"><strong>If it isn't tested, it's broken</strong></p>
<p class="incremental">Test-Driven Development means writing the tests before writing the functions.
As your tests pass, you know you're building what you want.</p>
<p class="incremental">We are going to write tests at every step of this lab. Along the way, we'll
learn a bit about the Python Standard Library module <tt class="docutils literal">unittest</tt>.</p>
<p class="incremental">You'll want to read more about this module. See our outline for reading
suggestions.</p>
</div>
<div class="slide" id="testing-setup">
<h1>Testing Setup</h1>
<p>In the same <tt class="docutils literal">flaskr_1</tt> directory, find and open the <tt class="docutils literal">flaskr_tests.py</tt> file
in your editor. Edit it to look like this:</p>
<pre class="code python small literal-block">
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">flaskr</span>
<span class="kn">import</span> <span class="nn">unittest</span>
<span class="kn">import</span> <span class="nn">tempfile</span>

<span class="k">class</span> <span class="nc">FlaskrTestCase</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">db_fd</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkstemp</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db_fd</span><span class="p">,</span> <span class="n">flaskr</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">'DATABASE'</span><span class="p">]</span> <span class="o">=</span> <span class="n">db_fd</span>
        <span class="n">flaskr</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">'TESTING'</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">flaskr</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">test_client</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">app</span> <span class="o">=</span> <span class="n">flaskr</span><span class="o">.</span><span class="n">app</span>
</pre>
</div>
<div class="slide" id="testing-teardown">
<h1>Testing Teardown</h1>
<p>Add the following method to your test class:</p>
<pre class="code python literal-block">
<span class="k">class</span> <span class="nc">FlaskrTestCase</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="o">...</span>

    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db_fd</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">flaskr</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">'DATABASE'</span><span class="p">])</span>
</pre>
</div>
<div class="slide" id="make-tests-runnable">
<h1>Make Tests Runnable</h1>
<p>And finally, add the following at the bottom of your <tt class="docutils literal">flaskr_tests.py</tt> file:</p>
<pre class="code python literal-block">
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">unittest</span><span class="o">.</span><span class="n">main</span><span class="p">()</span>
</pre>
<p class="incremental">Now, we're ready to add our first method.</p>
</div>
<div class="slide" id="test-databse-setup">
<h1>Test Databse Setup</h1>
<p>We'd like to test that our database is correctly initialized. The schema has
one table with three columns. Let's test that.</p>
<p>Add the following method to your test class in <tt class="docutils literal">flaskr_tests.py</tt>:</p>
<pre class="code python literal-block">
<span class="k">def</span> <span class="nf">test_database_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">con</span> <span class="o">=</span> <span class="n">flaskr</span><span class="o">.</span><span class="n">connect_db</span><span class="p">()</span>
    <span class="n">cur</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">'PRAGMA table_info(entries);'</span><span class="p">)</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rows</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span>
</pre>
</div>
<div class="slide" id="run-the-tests">
<h1>Run the Tests</h1>
<p>Since we added that <tt class="docutils literal">if __name__ == '__main__'</tt> block, we can simply run our
tests with a flask-aware python executable:</p>
<pre class="small literal-block">
(flaskenv)$ python flaskr_tests.py
F
======================================================================
FAIL: test_database_setup (__main__.FlaskrTestCase)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;flaskr_tests.py&quot;, line 23, in test_database_setup
    self.assertTrue(len(rows) == 3)
AssertionError: False is not True

----------------------------------------------------------------------
Ran 1 test in 0.011s

FAILED (failures=1)
</pre>
</div>
<div class="slide" id="make-the-test-pass">
<h1>Make the Test Pass</h1>
<p>Our database hasn't actually be properly created. We have no table and so no
rows are returned when we try to describe it. Let's fix that. Add the
following to <tt class="docutils literal">flaskr.py</tt>:</p>
<pre class="code python literal-block">
<span class="c"># add this import at the top</span>
<span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">closing</span>

<span class="c"># add this function after the connect_db function</span>
<span class="k">def</span> <span class="nf">init_db</span><span class="p">():</span>
    <span class="k">with</span> <span class="n">closing</span><span class="p">(</span><span class="n">connect_db</span><span class="p">())</span> <span class="k">as</span> <span class="n">db</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">app</span><span class="o">.</span><span class="n">open_resource</span><span class="p">(</span><span class="s">'schema.sql'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span><span class="o">.</span><span class="n">executescript</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
        <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</pre>
</div>
<div class="slide" id="initialize-the-db-in-tests">
<h1>Initialize the DB in Tests</h1>
<p>We also need to call that function in our <tt class="docutils literal">flaskr_tests.py</tt>, in the
<tt class="docutils literal">setUp</tt> method of our test case.</p>
<p>Add the following line at the end of that <tt class="docutils literal">setUp</tt> method:</p>
<pre class="code python literal-block">
<span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="n">flaskr</span><span class="o">.</span><span class="n">init_db</span><span class="p">()</span> <span class="c"># &lt;- add this at the end</span>
</pre>
<p class="incremental">Then, re-run the tests (<tt class="docutils literal">python flaskr_tests.py</tt>) and see what you get.</p>
<p class="incremental center"><strong>Wahoooo!</strong></p>
</div>
<div class="slide" id="initialize-the-db-irl">
<h1>Initialize the DB IRL</h1>
<p>Okay, so we know the <tt class="docutils literal">init_db</tt> function we added sets up the database
properly.</p>
<p class="incremental">We still need to do this in real life, so that we can work against the
database.</p>
<p class="incremental">Start up a python interpreter in your <tt class="docutils literal">flaskr_1</tt> folder and do the
following:</p>
<pre class="code python incremental literal-block">
<span class="kn">import</span> <span class="nn">flaskr</span>
<span class="n">flaskr</span><span class="o">.</span><span class="n">init_db</span><span class="p">()</span>
<span class="o">^</span><span class="n">D</span>
</pre>
</div>
<div class="slide" id="lab-2-part-2">
<h1>Lab 2 - Part 2</h1>
<p>Okay, we have a database. Now it's time to write stuff into it, and read it
back.</p>
<p class="incremental">Once again, we're going to start by writing tests.</p>
<p class="incremental">If you've fallen behind, or if you just want to start fresh, you can find the
base of what we've done so far in the <tt class="docutils literal">flaskr_2</tt> folder.</p>
</div>
<div class="slide" id="managing-db-connections">
<h1>Managing DB Connections</h1>
<p>Database connections should be bound to the borders of a request/response.</p>
<p class="incremental">Flask provides decorators that mark functions to be run at these borders:</p>
<ul class="incremental simple">
<li><tt class="docutils literal">&#64;before_request</tt>: any method decorated by this will be called before the
cycle begins</li>
<li><tt class="docutils literal">&#64;after_request</tt>: any method decorated by this will be called after the
cycle is complete. If an unhandled exception occurs, these functions are
skipped.</li>
<li><tt class="docutils literal">&#64;teardown_request</tt>: any method decorated by this will be called at the
end of the cycle, even if an unhandled exception occurs.</li>
</ul>
</div>
<div class="slide" id="manage-our-db">
<h1>Manage our DB</h1>
<p>Add the following code to our app (<tt class="docutils literal">flaskr.py</tt>):</p>
<pre class="code python small literal-block">
<span class="c"># add this import at the top:</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">g</span>

<span class="c"># add these function after init_db</span>
<span class="nd">&#64;app.before_request</span>
<span class="k">def</span> <span class="nf">before_request</span><span class="p">():</span>
    <span class="n">g</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">connect_db</span><span class="p">()</span>

<span class="nd">&#64;app.teardown_request</span>
<span class="k">def</span> <span class="nf">teardown_request</span><span class="p">(</span><span class="n">exception</span><span class="p">):</span>
    <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre>
<p class="incremental">We bind our db connection to the 'g' object, which is a global context flask
supplies to each request.</p>
</div>
<div class="slide" id="test-writing-entries">
<h1>Test Writing Entries</h1>
<p>We want to test that we can write an entry by providing a title and text. Add
the following method to <tt class="docutils literal">flaskr_tests.py</tt>:</p>
<pre class="code python small literal-block">
<span class="k">def</span> <span class="nf">test_write_entry</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">expected</span> <span class="o">=</span> <span class="p">(</span><span class="s">&quot;My Title&quot;</span><span class="p">,</span> <span class="s">&quot;My Text&quot;</span><span class="p">)</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">test_request_context</span><span class="p">(</span><span class="s">'/'</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">preprocess_request</span><span class="p">()</span>
        <span class="n">flaskr</span><span class="o">.</span><span class="n">write_entry</span><span class="p">(</span><span class="o">*</span><span class="n">expected</span><span class="p">)</span>
        <span class="n">con</span> <span class="o">=</span> <span class="n">flaskr</span><span class="o">.</span><span class="n">connect_db</span><span class="p">()</span>
        <span class="n">cur</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;select * from entries;&quot;</span><span class="p">)</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rows</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">expected</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">val</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre>
<p class="incremental">Note that we have to set up a request context, and preprocess it to get our
&#64;before_request method run.</p>
</div>
<div class="slide" id="write-an-entry">
<h1>Write an Entry</h1>
<p>Now we are ready to write an entry to our database. Add this function to
<tt class="docutils literal">flaskr.py</tt>:</p>
<pre class="code python literal-block">
<span class="k">def</span> <span class="nf">write_entry</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
    <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">'insert into entries (title, text) values (?, ?)'</span><span class="p">,</span>
                 <span class="p">[</span><span class="n">title</span><span class="p">,</span> <span class="n">text</span><span class="p">])</span>
    <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</pre>
<p class="incremental">When you're done, re-run your tests.  You should now be two for two.</p>
</div>
<div class="slide" id="test-reading-entries">
<h1>Test Reading Entries</h1>
<pre class="code python small literal-block">
<span class="k">def</span> <span class="nf">test_get_all_entries_empty</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">test_request_context</span><span class="p">(</span><span class="s">'/'</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">preprocess_request</span><span class="p">()</span>
        <span class="n">entries</span> <span class="o">=</span> <span class="n">flaskr</span><span class="o">.</span><span class="n">get_all_entries</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">entries</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">test_get_all_entries</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">expected</span> <span class="o">=</span> <span class="p">(</span><span class="s">&quot;My Title&quot;</span><span class="p">,</span> <span class="s">&quot;My Text&quot;</span><span class="p">)</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">test_request_context</span><span class="p">(</span><span class="s">'/'</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">preprocess_request</span><span class="p">()</span>
        <span class="n">flaskr</span><span class="o">.</span><span class="n">write_entry</span><span class="p">(</span><span class="o">*</span><span class="n">expected</span><span class="p">)</span>
        <span class="n">entries</span> <span class="o">=</span> <span class="n">flaskr</span><span class="o">.</span><span class="n">get_all_entries</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">entries</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">expected</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">entry</span><span class="p">[</span><span class="s">'title'</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">expected</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">entry</span><span class="p">[</span><span class="s">'text'</span><span class="p">])</span>
</pre>
</div>
<div class="slide" id="read-entries">
<h1>Read Entries</h1>
<p>Okay, so now we have 4 tests, and two fail, add this function to <tt class="docutils literal">flaskr.py</tt>:</p>
<pre class="code python small literal-block">
<span class="k">def</span> <span class="nf">get_all_entries</span><span class="p">():</span>
    <span class="n">cur</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">'select title, text from entries order by id desc'</span><span class="p">)</span>
    <span class="n">entries</span> <span class="o">=</span> <span class="p">[</span><span class="nb">dict</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">text</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()]</span>
    <span class="k">return</span> <span class="n">entries</span>
</pre>
<p class="incremental">Re-run your tests.  You should now have four passing tests.  Great Job!</p>
</div>
<div class="slide" id="lab-2-part-3">
<h1>Lab 2 - Part 3</h1>
<p>Now we can read and write blog entries, let's add views so we can see what
we're doing.</p>
<p class="incremental">Again.  Tests come first.</p>
<p class="incremental">And again, if you've fallen behind or want to start clean, the completed code
from our last step is in <tt class="docutils literal">flaskr_3</tt></p>
</div>
<div class="slide" id="test-the-front-page">
<h1>Test the Front Page</h1>
<p>Add the following tests to <tt class="docutils literal">flaskr_tests.py</tt>:</p>
<pre class="code literal-block">
def test_empty_listing(self):
    rv = self.client.get('/')
    assert 'No entries here so far' in rv.data

def test_listing(self):
    expected = (&quot;My Title&quot;, &quot;My Text&quot;)
    with self.app.test_request_context('/'):
        self.app.preprocess_request()
        flaskr.write_entry(*expected)
    rv = self.client.get('/')
    for value in expected:
        assert value in rv.data
</pre>
</div>
<div class="slide" id="template-inheritance">
<h1>Template Inheritance</h1>
<p>One aspect of Jinja2 templates we haven't seen yet is that templates can
inherit structure from other templates.</p>
<ul class="incremental simple">
<li>you can make replaceable blocks in templates with blocks: <tt class="docutils literal">{% block foo
<span class="pre">%}{%</span> endblock %}</tt>.</li>
<li>you can build on a template in a second template by extending: <tt class="docutils literal">{% extends
&quot;layout.html&quot; %}</tt> (this <em>must</em> be first)</li>
</ul>
<p class="incremental">We want the parts of our app to look alike, so let's create a basic layout
first.  Create a file <tt class="docutils literal">layout.html</tt> in the <tt class="docutils literal">templates</tt> directory.</p>
</div>
<div class="slide" id="creating-layout">
<h1>Creating Layout</h1>
<pre class="code jinja literal-block">
<span class="x">&lt;!DOCTYPE html&gt;
&lt;html&gt;
  &lt;head&gt;
    &lt;title&gt;Flaskr&lt;/title&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;h1&gt;Flaskr&lt;/h1&gt;
    &lt;div class=&quot;content&quot;&gt;
    </span><span class="cp">{%</span> <span class="k">block</span> <span class="nv">body</span> <span class="cp">%}{%</span> <span class="k">endblock</span> <span class="cp">%}</span><span class="x">
    &lt;/div&gt;
  &lt;/body&gt;
&lt;/html&gt;</span>
</pre>
</div>
<div class="slide" id="extending-layout">
<h1>Extending Layout</h1>
<p>Create a new file, <tt class="docutils literal">show_entries.html</tt> in <tt class="docutils literal">templates</tt>:</p>
<pre class="code jinja small literal-block">
<span class="cp">{%</span> <span class="k">extends</span> <span class="s2">&quot;layout.html&quot;</span> <span class="cp">%}</span><span class="x">
</span><span class="cp">{%</span> <span class="k">block</span> <span class="nv">body</span> <span class="cp">%}</span><span class="x">
  &lt;h2&gt;Posts&lt;/h2&gt;
  &lt;ul class=&quot;entries&quot;&gt;
  </span><span class="cp">{%</span> <span class="k">for</span> <span class="nv">entry</span> <span class="k">in</span> <span class="nv">entries</span> <span class="cp">%}</span><span class="x">
    &lt;li&gt;
      &lt;h2&gt;</span><span class="cp">{{</span> <span class="nv">entry.title</span> <span class="cp">}}</span><span class="x">&lt;/h2&gt;
      &lt;div class=&quot;entry_body&quot;&gt;
      </span><span class="cp">{{</span> <span class="nv">entry.text</span><span class="o">|</span><span class="nf">safe</span> <span class="cp">}}</span><span class="x">
      &lt;/div&gt;
    &lt;/li&gt;
  </span><span class="cp">{%</span> <span class="k">else</span> <span class="cp">%}</span><span class="x">
    &lt;li&gt;&lt;em&gt;No entries here so far&lt;/em&gt;&lt;/li&gt;
  </span><span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span><span class="x">
  &lt;/ul&gt;
</span><span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span>
</pre>
</div>
<div class="slide" id="creating-a-view">
<h1>Creating a View</h1>
<p>Now, we just need to hook up our entries to that template. In <tt class="docutils literal">flaskr.py</tt>
add the following code:</p>
<pre class="code python literal-block">
<span class="c"># at the top, import</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">render_template</span>

<span class="c"># and after our last functions:</span>
<span class="nd">&#64;app.route</span><span class="p">(</span><span class="s">'/'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">show_entries</span><span class="p">():</span>
    <span class="n">entries</span> <span class="o">=</span> <span class="n">get_all_entries</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">'show_entries.html'</span><span class="p">,</span> <span class="n">entries</span><span class="o">=</span><span class="n">entries</span><span class="p">)</span>
</pre>
<p class="incremental">Run our tests.  Should be 6 for 6 now.</p>
</div>
<div class="slide" id="authentication">
<h1>Authentication</h1>
<p>We don't want just anyone to be able to add new entries. So we want to be able
to authenticate a user.</p>
<p class="incremental">We'll be using built-in functionality of Flask to do this, but this
simplest-possible implementation should serve only as a guide.</p>
<p class="incremental">We'll start with the tests, of course.</p>
</div>
<div class="slide" id="test-authentication">
<h1>Test Authentication</h1>
<p>Back in <tt class="docutils literal">flaskr_tests.py</tt> add new test methods:</p>
<pre class="code python small literal-block">
<span class="k">def</span> <span class="nf">test_login_passes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">test_request_context</span><span class="p">(</span><span class="s">'/'</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">preprocess_request</span><span class="p">()</span>
        <span class="n">flaskr</span><span class="o">.</span><span class="n">do_login</span><span class="p">(</span><span class="n">flaskr</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">'USERNAME'</span><span class="p">],</span>
                        <span class="n">flaskr</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">'PASSWORD'</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'logged_in'</span><span class="p">,</span> <span class="bp">False</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">test_login_fails</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">test_request_context</span><span class="p">(</span><span class="s">'/'</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">preprocess_request</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">flaskr</span><span class="o">.</span><span class="n">do_login</span><span class="p">,</span>
                          <span class="n">flaskr</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">'USERNAME'</span><span class="p">],</span>
                          <span class="s">'incorrectpassword'</span><span class="p">)</span>
</pre>
</div>
<div class="slide" id="set-up-authentication">
<h1>Set Up Authentication</h1>
<p>Now, let's add the code in <tt class="docutils literal">flaskr.py</tt> to support this:</p>
<pre class="code python small literal-block">
<span class="c"># add an import</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">session</span>

<span class="c"># and configuration</span>
<span class="n">USERNAME</span> <span class="o">=</span> <span class="s">'admin'</span>
<span class="n">PASSWORD</span> <span class="o">=</span> <span class="s">'default'</span>

<span class="c"># and a function</span>
<span class="k">def</span> <span class="nf">do_login</span><span class="p">(</span><span class="n">usr</span><span class="p">,</span> <span class="n">pwd</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">usr</span> <span class="o">!=</span> <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">'USERNAME'</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span>
    <span class="k">elif</span> <span class="n">pwd</span> <span class="o">!=</span> <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">'PASSWORD'</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">session</span><span class="p">[</span><span class="s">'logged_in'</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
</pre>
</div>
<div class="slide" id="login-logout-in-tests">
<h1>Login/Logout in Tests</h1>
<p>Let's add tests for a view. We'll set up a form that redirects back to the
main view on success. First, methods to actually do the login/logout (in
<tt class="docutils literal">flaskr_tests.py</tt>):</p>
<pre class="code python literal-block">
<span class="k">def</span> <span class="nf">login</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s">'/login'</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
        <span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span>
        <span class="n">password</span><span class="o">=</span><span class="n">password</span>
    <span class="p">),</span> <span class="n">follow_redirects</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">logout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'/logout'</span><span class="p">,</span>
                           <span class="n">follow_redirects</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre>
</div>
<div class="slide" id="id4">
<h1>Test Authentication</h1>
<p>And now the test itself (again, <tt class="docutils literal">flaskr_tests.py</tt>):</p>
<pre class="code python literal-block">
<span class="k">def</span> <span class="nf">test_login_logout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">rv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">login</span><span class="p">(</span><span class="s">'admin'</span><span class="p">,</span> <span class="s">'default'</span><span class="p">)</span>
    <span class="k">assert</span> <span class="s">'You were logged in'</span> <span class="ow">in</span> <span class="n">rv</span><span class="o">.</span><span class="n">data</span>
    <span class="n">rv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">logout</span><span class="p">()</span>
    <span class="k">assert</span> <span class="s">'You were logged out'</span> <span class="ow">in</span> <span class="n">rv</span><span class="o">.</span><span class="n">data</span>
    <span class="n">rv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">login</span><span class="p">(</span><span class="s">'adminx'</span><span class="p">,</span> <span class="s">'default'</span><span class="p">)</span>
    <span class="k">assert</span> <span class="s">'Invalid Login'</span> <span class="ow">in</span> <span class="n">rv</span><span class="o">.</span><span class="n">data</span>
    <span class="n">rv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">login</span><span class="p">(</span><span class="s">'admin'</span><span class="p">,</span> <span class="s">'defaultx'</span><span class="p">)</span>
    <span class="k">assert</span> <span class="s">'Invalid Login'</span> <span class="ow">in</span> <span class="n">rv</span><span class="o">.</span><span class="n">data</span>
</pre>
<p class="incremental">We should be up to 9 tests, one failing</p>
</div>
<div class="slide" id="add-login-template">
<h1>Add Login Template</h1>
<p>Add <tt class="docutils literal">login.html</tt> to <tt class="docutils literal">templates</tt>:</p>
<pre class="code jinja tiny literal-block">
<span class="cp">{%</span> <span class="k">extends</span> <span class="s2">&quot;layout.html&quot;</span> <span class="cp">%}</span><span class="x">
</span><span class="cp">{%</span> <span class="k">block</span> <span class="nv">body</span> <span class="cp">%}</span><span class="x">
  &lt;h2&gt;Login&lt;/h2&gt;
  </span><span class="cp">{%</span> <span class="k">if</span> <span class="nv">error</span> -<span class="cp">%}</span><span class="x">
    &lt;p class=&quot;error&quot;&gt;&lt;strong&gt;Error&lt;/strong&gt; </span><span class="cp">{{</span> <span class="nv">error</span> <span class="cp">}}</span><span class="x">
  </span><span class="cp">{%</span>- <span class="k">endif</span> <span class="cp">%}</span><span class="x">
  &lt;form action=&quot;</span><span class="cp">{{</span> <span class="nv">url_for</span><span class="o">(</span><span class="s1">'login'</span><span class="o">)</span> <span class="cp">}}</span><span class="x">&quot; method=&quot;POST&quot;&gt;
    &lt;div class=&quot;field&quot;&gt;
      &lt;label for=&quot;username&quot;&gt;Username&lt;/label&gt;
      &lt;input type=&quot;text&quot; name=&quot;username&quot; id=&quot;username&quot;/&gt;
    &lt;/div&gt;
    &lt;div class=&quot;field&quot;&gt;
      &lt;label for=&quot;password&quot;&gt;Password&lt;/label&gt;
      &lt;input type=&quot;password&quot; name=&quot;password&quot; id=&quot;password&quot;/&gt;
    &lt;/div&gt;
    &lt;div class=&quot;control_row&quot;&gt;
      &lt;input type=&quot;submit&quot; name=&quot;Login&quot; value=&quot;Login&quot;/&gt;
    &lt;/div&gt;
  &lt;/form&gt;
</span><span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span>
</pre>
</div>
<div class="slide" id="add-login-logout-views">
<h1>Add Login/Logout Views</h1>
<p>And back in <tt class="docutils literal">flaskr.py</tt> add new code.  Let's start with imports:</p>
<pre class="code python literal-block">
<span class="c"># at the top, new imports</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">request</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">redirect</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">flash</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">url_for</span>
</pre>
</div>
<div class="slide" id="and-the-view-code">
<h1>And the View Code</h1>
<pre class="code python small literal-block">
<span class="nd">&#64;app.route</span><span class="p">(</span><span class="s">'/login'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">'GET'</span><span class="p">,</span> <span class="s">'POST'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">login</span><span class="p">():</span>
    <span class="n">error</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">'POST'</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">do_login</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">'username'</span><span class="p">],</span>
                     <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">'password'</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">error</span> <span class="o">=</span> <span class="s">&quot;Invalid Login&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">flash</span><span class="p">(</span><span class="s">'You were logged in'</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">'show_entries'</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">'login.html'</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>

<span class="nd">&#64;app.route</span><span class="p">(</span><span class="s">'/logout'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">logout</span><span class="p">():</span>
    <span class="n">session</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">'logged_in'</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
    <span class="n">flash</span><span class="p">(</span><span class="s">'You were logged out'</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">'show_entries'</span><span class="p">))</span>
</pre>
</div>
<div class="slide" id="about-flash">
<h1>About Flash</h1>
<p class="small">Flask provides <tt class="docutils literal">flash</tt> as a way of sending messages to the user from view
code. We need a place to show these messages. Add it to <tt class="docutils literal">layout.html</tt> (along
with links to log in and out)</p>
<pre class="code jinja small literal-block">
<span class="x">&lt;h1&gt;Flaskr&lt;/h1&gt;       &lt;!-- already there --&gt;
&lt;div class=&quot;metanav&quot;&gt; &lt;!-- add all this --&gt;
</span><span class="cp">{%</span> <span class="k">if</span> <span class="k">not</span> <span class="nv">session.logged_in</span> <span class="cp">%}</span><span class="x">
  &lt;a href=&quot;</span><span class="cp">{{</span> <span class="nv">url_for</span><span class="o">(</span><span class="s1">'login'</span><span class="o">)</span> <span class="cp">}}</span><span class="x">&quot;&gt;log in&lt;/a&gt;
</span><span class="cp">{%</span> <span class="k">else</span> <span class="cp">%}</span><span class="x">
  &lt;a href=&quot;</span><span class="cp">{{</span> <span class="nv">url_for</span><span class="o">(</span><span class="s1">'logout'</span><span class="o">)</span> <span class="cp">}}</span><span class="x">&quot;&gt;log_out&lt;/a&gt;
</span><span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span><span class="x">
&lt;/div&gt;
</span><span class="cp">{%</span> <span class="k">for</span> <span class="nv">message</span> <span class="k">in</span> <span class="nv">get_flashed_messages</span><span class="o">()</span> <span class="cp">%}</span><span class="x">
&lt;div class=&quot;flash&quot;&gt;</span><span class="cp">{{</span> <span class="nv">message</span> <span class="cp">}}</span><span class="x">&lt;/div&gt;
</span><span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span><span class="x">
&lt;div class=&quot;content&quot;&gt; &lt;!-- already there --&gt;</span>
</pre>
</div>
<div class="slide" id="adding-an-entry">
<h1>Adding an Entry</h1>
<p>We still lack a way to add an entry. We need a view to do that. Again, tests
first (in <tt class="docutils literal">flaskr_tests.py</tt>):</p>
<pre class="code python literal-block">
<span class="k">def</span> <span class="nf">test_add_entries</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">login</span><span class="p">(</span><span class="s">'admin'</span><span class="p">,</span> <span class="s">'default'</span><span class="p">)</span>
    <span class="n">rv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s">'/add'</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
        <span class="n">title</span><span class="o">=</span><span class="s">'Hello'</span><span class="p">,</span>
        <span class="n">text</span><span class="o">=</span><span class="s">'This is a post'</span>
    <span class="p">),</span> <span class="n">follow_redirects</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">assert</span> <span class="s">'No entries here so far'</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">rv</span><span class="o">.</span><span class="n">data</span>
    <span class="k">assert</span> <span class="s">'Hello'</span> <span class="ow">in</span> <span class="n">rv</span><span class="o">.</span><span class="n">data</span>
    <span class="k">assert</span> <span class="s">'This is a post'</span> <span class="ow">in</span> <span class="n">rv</span><span class="o">.</span><span class="n">data</span>
</pre>
</div>
<div class="slide" id="add-the-view">
<h1>Add the View</h1>
<p>We've already got all the stuff we need to write entries, we just need an
endpoint that will do it via the web (in <tt class="docutils literal">flaskr.py</tt>):</p>
<pre class="code python small literal-block">
<span class="c"># add an import</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">abort</span>

<span class="nd">&#64;app.route</span><span class="p">(</span><span class="s">'/add'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">'POST'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">add_entry</span><span class="p">():</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'logged_in'</span><span class="p">):</span>
        <span class="n">abort</span><span class="p">(</span><span class="mi">401</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">write_entry</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">'title'</span><span class="p">],</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">'text'</span><span class="p">])</span>
        <span class="n">flash</span><span class="p">(</span><span class="s">'New entry was successfully posted'</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">Error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">flash</span><span class="p">(</span><span class="s">'There was an error: </span><span class="si">%s</span><span class="s">'</span> <span class="o">%</span> <span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">'show_entries'</span><span class="p">))</span>
</pre>
</div>
<div class="slide" id="where-do-entries-come-from">
<h1>Where do Entries Come From</h1>
<p>Finally, we're almost done. We can log in and log out. We can add entries and
view them. But look at that last view. Do you see a call to
<tt class="docutils literal">render_template</tt> in there at all?</p>
<p class="incremental">There isn't one. That's because that view is never meant to be be visible.
Look carefully at the logic. What happens?</p>
<p class="incremental">So where do the form values come from?</p>
<p class="incremental">Let's add a form to the main view.  Open <tt class="docutils literal">show_entries.html</tt></p>
</div>
<div class="slide" id="provide-a-form">
<h1>Provide a Form</h1>
<pre class="code jinja small literal-block">
<span class="cp">{%</span> <span class="k">block</span> <span class="nv">body</span> <span class="cp">%}</span><span class="x">  &lt;!-- already there --&gt;
</span><span class="cp">{%</span> <span class="k">if</span> <span class="nv">session.logged_in</span> <span class="cp">%}</span><span class="x">
&lt;form action=&quot;</span><span class="cp">{{</span> <span class="nv">url_for</span><span class="o">(</span><span class="s1">'add_entry'</span><span class="o">)</span> <span class="cp">}}</span><span class="x">&quot; method=&quot;POST&quot; class=&quot;add_entry&quot;&gt;
  &lt;div class=&quot;field&quot;&gt;
    &lt;label for=&quot;title&quot;&gt;Title&lt;/label&gt;
    &lt;input type=&quot;text&quot; size=&quot;30&quot; name=&quot;title&quot; id=&quot;title&quot;/&gt;
  &lt;/div&gt;
  &lt;div class=&quot;field&quot;&gt;
    &lt;label for=&quot;text&quot;&gt;Text&lt;/label&gt;
    &lt;textarea name=&quot;text&quot; id=&quot;text&quot; rows=&quot;5&quot; cols=&quot;80&quot;&gt;&lt;/textarea&gt;
  &lt;/div&gt;
  &lt;div class=&quot;control_row&quot;&gt;
    &lt;input type=&quot;submit&quot; value=&quot;Share&quot; name=&quot;Share&quot;/&gt;
  &lt;/div&gt;
&lt;/form&gt;
</span><span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span><span class="x">
&lt;h2&gt;Posts&lt;/h2&gt;  &lt;!-- already there --&gt;</span>
</pre>
</div>
<div class="slide" id="all-done">
<h1>All Done</h1>
<p>Okay.  That's it.  We've got an app all written.</p>
<p class="incremental">So far, we haven't actually touched our browsers at all, but we have
reasonable certainty that this works because of our tests. Let's try it.</p>
<p class="incremental">In the terminal where you've been running tests, run our flaskr app:</p>
<pre class="incremental literal-block">
(flaskenv)$ python flaskr.py
* Running on http://127.0.0.1:5000/
* Restarting with reloader
</pre>
</div>
<div class="slide" id="the-big-payoff">
<h1>The Big Payoff</h1>
<p>Now load <tt class="docutils literal"><span class="pre">http://localhost:5000/</span></tt> in your browser and enjoy your reward.</p>
</div>
<div class="slide" id="lab-2-part-4">
<h1>Lab 2 - Part 4</h1>
<p>On the other hand, what we've got here is pretty ugly.  We could prettify it.</p>
<p class="incremental">Again, if you want to start fresh or you fell behind you can find code
completed to this point in <tt class="docutils literal">flaskr_4</tt>.</p>
<p class="incremental">In that directory inside the <tt class="docutils literal">static</tt> directory you will find
<tt class="docutils literal">styles.css</tt>. Open it in your editor.  It contains basic CSS for this app.</p>
<p class="incremental">We'll need to include this file in our <tt class="docutils literal">layout.html</tt>.</p>
</div>
<div class="slide" id="static-files">
<h1>Static Files</h1>
<p>Like page templates, Flask locates static resources like images, css and
javascript by looking for a <tt class="docutils literal">static</tt> directory next to the app module.</p>
<p class="incremental">You can use the special url endpoint <tt class="docutils literal">static</tt> to build urls that point here.
Open <tt class="docutils literal">layout.html</tt> and add the following:</p>
<pre class="code jinja small incremental literal-block">
<span class="x">&lt;head&gt;  &lt;!-- you only need to add the &lt;link&gt; below --&gt;
  &lt;title&gt;Flaskr&lt;/title&gt;
  &lt;link href=&quot;</span><span class="cp">{{</span> <span class="nv">url_for</span><span class="o">(</span><span class="s1">'static'</span><span class="o">,</span> <span class="nv">filename</span><span class="o">=</span><span class="s1">'style.css'</span><span class="o">)</span> <span class="cp">}}</span><span class="x">&quot; rel=&quot;stylesheet&quot; type=&quot;text/css&quot;&gt;
&lt;/head&gt;</span>
</pre>
</div>
<div class="slide" id="deploying">
<h1>Deploying</h1>
<p>First, move the source code to your VM:</p>
<pre class="literal-block">
(flaskenv)$ cd ../
(flaskenv)$ tar -czvf flaskr.tgz flaskr
(flaskenv)$ scp flaskr.tgz &lt;your_vm&gt;:~/
(flaskenv)$ ssh &lt;your_vm&gt;
$ tar -zxvf flaskr.tgz
</pre>
<p>Then, on your VM, set up a virtualenv with Flask installed</p>
</div>
<div class="slide" id="id5">
<h1>Deploying</h1>
<p>You'll need to make some changes to mod_wsgi configuration.</p>
<ul class="simple">
<li>Open <tt class="docutils literal"><span class="pre">/etc/apache2/sites-available/default</span></tt> in an editor (on the VM)</li>
<li>Add the following line at the top (outside the VirtualHost block):
<tt class="docutils literal">WSGIPythonHome /path/to/flaskenv</tt></li>
<li>Delete all other lines refering to mod_wsgi configuration</li>
<li>Add the following in the VirtualHost block:</li>
</ul>
<pre class="literal-block">
WSGIScriptAlias / /var/www/flaskr.wsgi
</pre>
</div>
<div class="slide" id="id6">
<h1>Deploying</h1>
<p>Finally, you'll need to add the named wsgi file and edit it to match:</p>
<pre class="literal-block">
$ sudo touch /var/www/flaskr.wsgi
$ sudo vi /var/www/flasrk.wsgi


import sys
sys.path.insert(0, 'path/to/flaskr') # the flaskr app you uploaded

from flaskr import app as application
</pre>
</div>
<div class="slide" id="id7">
<h1>Deploying</h1>
<p>Finally, restart apache and bask in the glow:</p>
<pre class="literal-block">
$ sudo apache2ctl configtest
$ sudo /etc/init.d/apache2 graceful
</pre>
<p>Load <a class="reference external" href="http://your_vm/">http://your_vm/</a></p>
<p>Wheeee!</p>
</div>
<div class="slide" id="going-further">
<h1>Going Further</h1>
<p>It's not too hard to see ways you could improve this.</p>
<ul class="incremental simple">
<li>For my part, I made a version using Bootstrap.js.</li>
<li>You could limit the number of posts shown on the front page.</li>
<li>You could add dates to the posts and provide archived views for older posts.</li>
<li>You could add the ability to edit existing posts (and add an updated date to the schema)</li>
<li>...</li>
</ul>
</div>
<div class="slide" id="but-instead">
<h1>But Instead</h1>
<p>Instead of doing any of that, this week's assignment is a bit different.</p>
<p class="incremental">You've implemented an app in one Small Framework. I want you to do it all
again, in a different Small Framework.</p>
<p class="incremental">While you're working on it, think about the differences between your new
Framework and Flask. What do you like more? What do you like less? How might
this influence your choice of Frameworks in the future?</p>
</div>
<div class="slide" id="assignment">
<h1>Assignment</h1>
<ul class="simple">
<li>Re-implement the Flaskr app we built in class in a different Small
Framework.</li>
<li>There are several named in the class outline, and in this presentation.</li>
<li>Pick one of them, or a different one of your choice.  It must be Python.</li>
<li>When you are finished, add your source code and a README that talks about
your experience to the <tt class="docutils literal">athome</tt> folder of week05.</li>
<li>Tell me about your new Framework. Discuss the points above regarding
differences.</li>
</ul>
</div>
<div class="slide" id="submitting-the-assignment">
<h1>Submitting The Assignment</h1>
<ul class="simple">
<li>Try to get your code running on your VM</li>
<li>Add your source code, in it's entirety, to the <tt class="docutils literal">athome</tt> folder for week 5</li>
<li>Add a README.txt file that discusses the experience.</li>
<li>Commit your changes to your fork of the class repository and send me a pull
request</li>
</ul>
</div>
</div>
</body>
</html>
