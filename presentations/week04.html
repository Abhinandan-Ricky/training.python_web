<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.9.1: http://docutils.sourceforge.net/" />
<meta name="version" content="S5 1.1" />
<title>Internet Programming with Python</title>
<link rel="stylesheet" href="ui/uw_pce_theme/pretty.css" type="text/css" />
<!-- configuration parameters -->
<meta name="defaultView" content="slideshow" />
<meta name="controlVis" content="hidden" />
<!-- style sheet links -->
<script src="ui/uw_pce_theme/slides.js" type="text/javascript"></script>
<link rel="stylesheet" href="ui/uw_pce_theme/slides.css"
      type="text/css" media="projection" id="slideProj" />
<link rel="stylesheet" href="ui/uw_pce_theme/outline.css"
      type="text/css" media="screen" id="outlineStyle" />
<link rel="stylesheet" href="ui/uw_pce_theme/print.css"
      type="text/css" media="print" id="slidePrint" />
<link rel="stylesheet" href="ui/uw_pce_theme/opera.css"
      type="text/css" media="projection" id="operaFix" />
</head>
<body>
<div class="layout">
<div id="controls"></div>
<div id="currentSlide"></div>
<div id="header">

</div>
<div id="footer">
<h1>Internet Programming with Python</h1>
<h2><a class="reference external" href="http://github.com/cewing/training.python_web">View document source</a>.
</h2>
</div>
</div>
<div class="presentation">
<div class="slide" id="slide0">
<h1 class="title">Internet Programming with Python</h1>

<img alt="img/gateway.jpg" class="align-left" src="img/gateway.jpg" style="width: 50%;" />
<p>Week 4: CGI, WSGI and Living Online</p>
<p class="intro-blurb">Wherein we discover the gateways to dynamic processes on a server.</p>
<p class="image-credit">image: The Wandering Angel <a class="reference external" href="http://www.flickr.com/photos/wandering_angel/1467802750/">http://www.flickr.com/photos/wandering_angel/1467802750/</a> - CC-BY</p>

</div>
<div class="slide" id="but-first">
<h1>But First</h1>
<p class="big-centered">Review from the Assignment</p>
</div>
<div class="slide" id="and-second">
<h1>And Second</h1>
<p class="big-centered">Questions from the Reading?</p>
</div>
<div class="slide" id="and-now">
<h1>And Now...</h1>
<p class="big-centered">Gateways</p>
</div>
<div class="slide" id="think-back">
<h1>Think Back</h1>
<p>In week two, we wrote an HTTP server.</p>
<p>We set up the server to be <em>dynamic</em> by returning the output of a python
script</p>
<p class="incremental">But what if we want to pass information to that script?</p>
<p class="incremental">How do we let the script have access to information about the HTTP request
itself?</p>
</div>
<div class="slide" id="stepping-away">
<h1>Stepping Away</h1>
<p>Let's think about this same problem in another realm, the command line.</p>
<p class="incremental">In a <tt class="docutils literal">bash</tt> shell we can do this:</p>
<pre class="incremental literal-block">
$ export VARIABLE='some_value'
$ echo this is the value: $VARIABLE
this is the value: some_value
</pre>
</div>
<div class="slide" id="environment">
<h1>Environment</h1>
<p>This new variable is now part of our shell <strong>environment</strong>, and we can see that:</p>
<pre class="incremental literal-block">
$ printenv
VARIABLE=some_value
TERM_PROGRAM=iTerm.app
TERM=xterm
SHELL=/bin/bash
...
</pre>
</div>
<div class="slide" id="environment-in-python">
<h1>Environment in Python</h1>
<p>We can see this <em>environment</em> in Python, too:</p>
<pre class="literal-block">
$ python
</pre>
<pre class="code python literal-block">
<span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">os</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">'VARIABLE'</span><span class="p">]</span>
<span class="n">some_value</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
<span class="p">[</span><span class="s">'VERSIONER_PYTHON_PREFER_32_BIT'</span><span class="p">,</span> <span class="s">'VARIABLE'</span><span class="p">,</span>
 <span class="s">'LOGNAME'</span><span class="p">,</span> <span class="s">'USER'</span><span class="p">,</span> <span class="s">'PATH'</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</pre>
</div>
<div class="slide" id="altering-the-environment">
<h1>Altering the Environment</h1>
<p>You can alter os environment values while in Python:</p>
<pre class="code python literal-block">
<span class="o">&gt;&gt;&gt;</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">'VARIABLE'</span><span class="p">]</span> <span class="o">=</span> <span class="s">'new_value'</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">'VARIABLE'</span><span class="p">]</span>
<span class="n">new_value</span>
</pre>
<p class="incremental">But that doesn't change the original value, <em>outside</em> Python:</p>
<pre class="incremental literal-block">
&gt;&gt;&gt; ^D
$ echo this is the value: $VARIABLE
this is the value: some_value
</pre>
</div>
<div class="slide" id="lessons-learned">
<h1>Lessons Learned</h1>
<ul class="incremental simple">
<li>Subprocesses inherit their environment from their Parent</li>
<li>Parents do not see changes to environment in subprocesses</li>
<li>In Python, you can actually set the environment for a subprocess explicitly</li>
</ul>
<pre class="incremental small literal-block">
subprocess.Popen(args, bufsize=0, executable=None,
                 stdin=None, stdout=None, stderr=None,
                 preexec_fn=None, close_fds=False,
                 shell=False, cwd=None, env=None, # &lt;-------
                 universal_newlines=False, startupinfo=None,
                 creationflags=0)
</pre>
</div>
<div class="slide" id="web-environment">
<h1>Web Environment</h1>
<p class="big-centered">CGI is little more than a set of standard environmental variables</p>
</div>
<div class="slide" id="rfc-3875">
<h1>RFC 3875</h1>
<p>First discussed in 1993, formalized in 1997, the current version (1.1) has
been in place since 2004.</p>
<p>From the preamble:</p>
<p class="center"><em>This memo provides information for the Internet community. It does not specify
an Internet standard of any kind.</em></p>
<p class="image-credit">RFC 3875 - CGI Version 1.1: <a class="reference external" href="http://tools.ietf.org/html/rfc3875">http://tools.ietf.org/html/rfc3875</a></p>
</div>
<div class="slide" id="meta-variables">
<h1>Meta-Variables</h1>
<pre class="small literal-block">
4.  The CGI Request . . . . . . . . . . . . . . . . . . . . . . .  10
    4.1. Request Meta-Variables . . . . . . . . . . . . . . . . .  10
         4.1.1.  AUTH_TYPE. . . . . . . . . . . . . . . . . . . .  11
         4.1.2.  CONTENT_LENGTH . . . . . . . . . . . . . . . . .  12
         4.1.3.  CONTENT_TYPE . . . . . . . . . . . . . . . . . .  12
         4.1.4.  GATEWAY_INTERFACE. . . . . . . . . . . . . . . .  13
         4.1.5.  PATH_INFO. . . . . . . . . . . . . . . . . . . .  13
         4.1.6.  PATH_TRANSLATED. . . . . . . . . . . . . . . . .  14
         4.1.7.  QUERY_STRING . . . . . . . . . . . . . . . . . .  15
         4.1.8.  REMOTE_ADDR. . . . . . . . . . . . . . . . . . .  15
         4.1.9.  REMOTE_HOST. . . . . . . . . . . . . . . . . . .  16
         4.1.10. REMOTE_IDENT . . . . . . . . . . . . . . . . . .  16
         4.1.11. REMOTE_USER. . . . . . . . . . . . . . . . . . .  16
         4.1.12. REQUEST_METHOD . . . . . . . . . . . . . . . . .  17
         4.1.13. SCRIPT_NAME. . . . . . . . . . . . . . . . . . .  17
         4.1.14. SERVER_NAME. . . . . . . . . . . . . . . . . . .  17
         4.1.15. SERVER_PORT. . . . . . . . . . . . . . . . . . .  18
         4.1.16. SERVER_PROTOCOL. . . . . . . . . . . . . . . . .  18
         4.1.17. SERVER_SOFTWARE. . . . . . . . . . . . . . . . .  19
</pre>
</div>
<div class="slide" id="running-cgi">
<h1>Running CGI</h1>
<p>You have a couple of options:</p>
<ul class="incremental simple">
<li>Python Standard Library CGIHTTPServer</li>
<li>Apache</li>
<li>Some other HTTP server that implements CGI (lighttpd, ...?)</li>
</ul>
<p class="incremental">Let's start locally by using the Python module</p>
</div>
<div class="slide" id="running-cgi-first-test">
<h1>Running CGI - First Test</h1>
<p>Make sure you have the latest source of the class documentation, then:</p>
<ul class="incremental simple">
<li>Open <em>two</em> terminal windows and in both, <tt class="docutils literal">cd</tt> to the
<tt class="docutils literal">assignments/week04/lab</tt> directory</li>
<li>In the first terminal, run <tt class="docutils literal">python <span class="pre">-m</span> CGIHTTPServer</tt></li>
<li>Open a web browser and load <tt class="docutils literal"><span class="pre">http://localhost:8000/</span></tt></li>
<li>Click on <em>CGI Test 1</em></li>
</ul>
</div>
<div class="slide" id="did-that-work">
<h1>Did that work?</h1>
<ul class="simple">
<li>If nothing at all happens, check your terminal window</li>
<li>Look for this: <tt class="docutils literal">OSError: [Errno 13] Permission denied</tt></li>
<li>If you see something like that, check permissions for <tt class="docutils literal"><span class="pre">cgi-bin</span></tt> <em>and</em>
<tt class="docutils literal">cgi_1.py</tt></li>
<li>The file must be executable, the directory needs to be readable <em>and</em>
executable.</li>
</ul>
</div>
<div class="slide" id="break-it">
<h1>Break It</h1>
<p>Once that's working correctly, let's play with breaking it. Start by making
the file not exectuable:</p>
<pre class="incremental small literal-block">
$ ls -l cgi-bin/cgi_1.py
-rwxr-xr-x 1 cewing  staff  42 Jan 17 22:30 cgi-bin/cgi_1.py
$ chmod 444 cgi-bin/cgi_1.py
$ ls -l cgi-bin/cgi_1.py
-r--r--r-- 1 cewing  staff  42 Jan 17 22:35 cgi-bin/cgi_1.py
</pre>
<p class="incremental">Reload your web browser and see what happens.</p>
<p class="incremental">Put the permissions back to how they were before.</p>
</div>
<div class="slide" id="break-it-differently">
<h1>Break It Differently</h1>
<p>Okay, so problems with permissions can lead to failure. How about errors in
the script?  What happens there?</p>
<ul class="incremental simple">
<li>Open <tt class="docutils literal"><span class="pre">assignments/week04/lab/cgi-bin/cgi_1.py</span></tt> in an editor</li>
<li>Before where it says <tt class="docutils literal">cgi.test()</tt>, add a single line:</li>
</ul>
<pre class="code python incremental literal-block">
<span class="mi">1</span> <span class="o">/</span> <span class="mi">0</span>
</pre>
<p class="incremental">Reload your browser, what happens now?</p>
</div>
<div class="slide" id="errors-in-cgi">
<h1>Errors in CGI</h1>
<p>CGI is famously difficult to debug.  There are reasons for this:</p>
<ul class="incremental simple">
<li>CGI is designed to provide access to runnable processes to <em>the internet</em></li>
<li>The internet is a wretched hive of scum and villainy</li>
<li>Revealing error conditions can expose data that could be exploited</li>
</ul>
</div>
<div class="slide" id="viewing-errors-in-python-cgi">
<h1>Viewing Errors in Python CGI</h1>
<p>Back in your editor, add the following lines, just below <tt class="docutils literal">import cgi</tt>:</p>
<pre class="code python incremental literal-block">
<span class="kn">import</span> <span class="nn">cgitb</span>
<span class="n">cgitb</span><span class="o">.</span><span class="n">enable</span><span class="p">()</span>
</pre>
<p class="incremental">Now, reload again.</p>
</div>
<div class="slide" id="cgitb-output">
<h1>cgitb Output</h1>
<img alt="img/cgitb_output.png" class="align-center" src="img/cgitb_output.png" style="width: 100%;" />
</div>
<div class="slide" id="scraps">
<h1>scraps</h1>
<p>How to run CGI scripts</p>
<ul class="simple">
<li>locally</li>
<li>on a server</li>
</ul>
<p>How does WSGI differ from CGI?</p>
<p>What is WSGI?</p>
<p>Is WSGI Python-specific?</p>
<p>How to run locally</p>
<p>How to run on a server</p>
</div>
</div>
</body>
</html>
